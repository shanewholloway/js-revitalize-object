'use strict';

const root_obj = {},
      root_list = [];
const ObjMap = 'undefined' !== typeof WeakMap ? WeakMap : Map;

class Revitalization extends Function {
  constructor() {
    throw new Error('Use the static .create() instead of new');
  }

  static create(token_p) {
    register.token = token_p || '\u039E'; // 'Îž'

    const lutRevive = new Map();
    const lutPreserve = new ObjMap();

    const self = Object.setPrototypeOf(register, this.prototype);
    Object.defineProperties(self, { lookupReviver: { value: lutRevive.get.bind(lutRevive) }, lookupPreserver: { value: lutPreserve.get.bind(lutPreserve) }, _setReviver: { value: _setReviver } });

    self.initRegistery(root_obj, root_list);
    return self;

    function register() {
      return self.register.apply(self, arguments);
    }

    function _setReviver(entry, kinds, matchers) {
      lutRevive.set(entry.kind, entry);
      return {
        alias(...kinds) {
          for (const each of kinds) {
            if (each) {
              lutRevive.set(each, entry);
            }
          }
          return this;
        }, match(...matchers) {
          for (const each of matchers) {
            if (null != each) {
              lutPreserve.set(each, entry);
            }
          }
          return this;
        } };
    }
  }

  initRegistery(root_obj, root_list) {
    this.register({ kind: '{root}',
      revive(obj, entry) {
        Object.assign(obj, entry.body);
      } }).match(root_obj);

    this.register({ kind: '[root]',
      preserve(rootList) {
        return { _: rootList.slice() };
      }, init(entry) {
        return [];
      }, revive(rootList, entry) {
        rootList.push.apply(rootList, entry.body._);
      } }).match(root_list);
  }

  register(revitalizer) {
    if ('kind' in revitalizer && revitalizer.revive) {
      return this.registerReviver(revitalizer);
    }

    let tgt;
    if (undefined !== revitalizer.prototype) {
      tgt = revitalizer.prototype[this.token];
      if (undefined !== tgt) {
        if ('function' === typeof tgt) {
          tgt = tgt.call(revitalizer.prototype, this);
          if (null == tgt) {
            return;
          }
        }
        if ('string' === typeof tgt) {
          return this.registerClass(tgt, revitalizer);
        }
      }
    }

    tgt = revitalizer[this.token];
    if (undefined !== tgt) {
      if ('function' === typeof tgt) {
        tgt = tgt.call(revitalizer, this);
        if (null == tgt) {
          return;
        }
      }
      if ('string' === typeof tgt) {
        return this.registerProto(tgt, revitalizer.prototype || revitalizer).match(revitalizer);
      }
    }

    throw new TypeError(`Unrecognized revitalization registration`);
  }

  registerReviver(entry) {
    {
      const kind = entry.kind;
      if ('string' !== typeof kind && true !== kind && false !== kind && null !== kind) {
        throw new TypeError(`"kind" must be a string`);
      }

      if (entry.init && 'function' !== typeof entry.init) {
        throw new TypeError('"init" must be a function');
      }

      if ('function' !== typeof entry.revive) {
        throw new TypeError('"revive" must be a function');
      }

      if (entry.preserve && 'function' !== typeof entry.preserve) {
        throw new TypeError('"preserve" must be a function if provided');
      }
    }

    return this._setReviver(entry);
  }

  registerClass(kind, klass) {
    return this.registerReviver({ kind,
      revive(obj, entry) {
        obj = Object.assign(obj, entry.body);
        Object.setPrototypeOf(obj, klass.prototype);
      } }).match(klass, klass.prototype);
  }

  registerProto(kind, proto) {
    return this.registerReviver({ kind,
      revive(obj, entry) {
        obj = Object.assign(obj, entry.body);
        Object.setPrototypeOf(obj, proto);
      } }).match(proto);
  }

  decode(aString, ctx) {
    if (null == ctx) {
      ctx = {};
    }
    const token = this.token,
          lookupReviver = this.lookupReviver;

    const queue = [],
          byOid = new Map();
    JSON.parse(aString, _json_create);

    const refs = new ObjMap();
    JSON.parse(aString, _json_restore);

    const evts = {};
    const _start = Promise.resolve().then(() => queue.reverse().map(entry => {
      entry.evts = evts;
      return entry.reviver.revive(entry.obj, entry, ctx);
    }));

    evts.started = _start.then(lst => lst.length);
    evts.finished = _start.then(lst => Promise.all(lst).then(lst => lst.length));

    evts.done = evts.finished.then(() => {
      const { obj, promise } = byOid.get(0);
      return undefined === promise ? obj : promise.then(ans => ans !== undefined ? ans : obj);
    });
    return evts.done;

    function _json_create(key, value) {
      if (token === key) {
        if ('number' === typeof value) {} else if (Array.isArray(value)) {
          delete this[token];

          const [kind, oid] = value;
          const reviver = lookupReviver(kind);
          if (undefined === reviver) {
            throw new ReviverNotFound(`Missing registered reviver for kind "${kind}"`);
          }

          const entry = { kind, oid, reviver, body: this };

          entry.obj = reviver.init ? reviver.init(entry, ctx) : Object.create(null);

          byOid.set(oid, entry);
          queue.push(entry);
        }
        return;
      }

      return value;
    }

    function _json_restore(key, value) {
      if (token === key) {
        if ('number' === typeof value) {
          refs.set(this, byOid.get(value).obj);
        } else if (Array.isArray(value)) {
          const entry = byOid.get(value[1]);
          entry.body = this;
          refs.set(this, entry.obj);
        }
        return;
      } else if (null === value || 'object' !== typeof value) {
        return value;
      }

      const ans = refs.get(value);
      return ans !== undefined ? ans : value;
    }
  }

  encode(anObject, ctx) {
    const refs = [];
    const promise = this.encodeObjects(anObject, ctx, (err, entry) => {
      refs[entry.oid] = entry.content;
    });

    const key = JSON.stringify(`${this.token}refs`);
    return promise.then(() => `{${key}: [\n  ${refs.join(',\n  ')} ]}\n`);
  }

  encodeObjects(anObject, ctx, callback) {
    if ('function' === typeof ctx) {
      callback = ctx;ctx = {};
    } else if (null == ctx) {
      ctx = {};
    }

    const token = this.token,
          lookupPreserver = this.lookupPreserver,
          findPreserver = this._boundFindPreserveForObj();

    const queue = [],
          lookup = new Map();
    JSON.stringify(anObject, _json_replacer);

    return _encodeQueue();

    function _encodeQueue() {
      if (0 === queue.length) {
        return Promise.resolve();
      }

      const promises = [];
      while (0 !== queue.length) {
        const tip = queue.shift(),
              oid = tip.oid;
        promises.push(tip.then(body => {
          const content = JSON.stringify(body, _json_replacer);
          return callback(null, { oid, body, content });
        }).catch(err => callback(err)));
      }

      return Promise.all(promises).then(_encodeQueue);
    }

    function _json_replacer(key, dstValue) {
      // srcValue !== dstValue for objects with .toJSON() methods
      const srcValue = this[key];

      if (dstValue === null || 'object' !== typeof srcValue) {
        return dstValue;
      }

      const prev = lookup.get(srcValue);
      if (undefined !== prev) {
        return prev; // already serialized -- reference existing item
      }let entry = findPreserver(srcValue);
      if (undefined === entry) {
        // not a "special" preserved item
        if (anObject !== srcValue) {
          return dstValue; // so serialize normally
        }
        // but it is the root, so store at oid 0
        entry = lookupPreserver(Array.isArray(dstValue) ? root_list : root_obj);
      }

      // register id for object and return a JSON serializable version
      const oid = lookup.size;
      const ref = { [token]: oid };
      lookup.set(srcValue, ref

      // transform live object into preserved form
      );const body = { [token]: [entry.kind, oid] };
      const promise = Promise.resolve(entry.preserve ? entry.preserve(dstValue, srcValue, ctx) : dstValue).then(attrs => Object.assign(body, attrs));

      promise.oid = oid;
      queue.push(promise);
      return ref;
    }
  }

  _boundFindPreserveForObj() {
    const lookupPreserver = this.lookupPreserver;
    return function (obj) {
      let entry = lookupPreserver(obj);
      if (undefined !== entry) {
        return entry;
      }

      entry = lookupPreserver(obj.constructor);
      if (undefined !== entry) {
        return entry;
      }

      let proto = obj;
      while (null !== (proto = Object.getPrototypeOf(proto))) {
        let entry = lookupPreserver(proto);
        if (undefined !== entry) {
          return entry;
        }
      }
    };
  }
}

class ReviverNotFound extends Error {}

const createRegistry = Revitalization.create.bind(Revitalization);

module.exports = exports = createRegistry();
Object.assign(exports, { Revitalization, ReviverNotFound,
  createRegistry, create: createRegistry });
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NvZGUvaW5kZXguanMiXSwibmFtZXMiOlsicm9vdF9vYmoiLCJyb290X2xpc3QiLCJPYmpNYXAiLCJXZWFrTWFwIiwiTWFwIiwiUmV2aXRhbGl6YXRpb24iLCJGdW5jdGlvbiIsImNvbnN0cnVjdG9yIiwiRXJyb3IiLCJjcmVhdGUiLCJ0b2tlbl9wIiwicmVnaXN0ZXIiLCJ0b2tlbiIsImx1dFJldml2ZSIsImx1dFByZXNlcnZlIiwic2VsZiIsIk9iamVjdCIsInNldFByb3RvdHlwZU9mIiwicHJvdG90eXBlIiwiZGVmaW5lUHJvcGVydGllcyIsImxvb2t1cFJldml2ZXIiLCJ2YWx1ZSIsImdldCIsImJpbmQiLCJsb29rdXBQcmVzZXJ2ZXIiLCJfc2V0UmV2aXZlciIsImluaXRSZWdpc3RlcnkiLCJhcHBseSIsImFyZ3VtZW50cyIsImVudHJ5Iiwia2luZHMiLCJtYXRjaGVycyIsInNldCIsImtpbmQiLCJhbGlhcyIsImVhY2giLCJtYXRjaCIsInJldml2ZSIsIm9iaiIsImFzc2lnbiIsImJvZHkiLCJwcmVzZXJ2ZSIsInJvb3RMaXN0IiwiXyIsInNsaWNlIiwiaW5pdCIsInB1c2giLCJyZXZpdGFsaXplciIsInJlZ2lzdGVyUmV2aXZlciIsInRndCIsInVuZGVmaW5lZCIsImNhbGwiLCJyZWdpc3RlckNsYXNzIiwicmVnaXN0ZXJQcm90byIsIlR5cGVFcnJvciIsImtsYXNzIiwicHJvdG8iLCJkZWNvZGUiLCJhU3RyaW5nIiwiY3R4IiwicXVldWUiLCJieU9pZCIsIkpTT04iLCJwYXJzZSIsIl9qc29uX2NyZWF0ZSIsInJlZnMiLCJfanNvbl9yZXN0b3JlIiwiZXZ0cyIsIl9zdGFydCIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsInJldmVyc2UiLCJtYXAiLCJyZXZpdmVyIiwic3RhcnRlZCIsImxzdCIsImxlbmd0aCIsImZpbmlzaGVkIiwiYWxsIiwiZG9uZSIsInByb21pc2UiLCJhbnMiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJvaWQiLCJSZXZpdmVyTm90Rm91bmQiLCJlbmNvZGUiLCJhbk9iamVjdCIsImVuY29kZU9iamVjdHMiLCJlcnIiLCJjb250ZW50Iiwic3RyaW5naWZ5Iiwiam9pbiIsImNhbGxiYWNrIiwiZmluZFByZXNlcnZlciIsIl9ib3VuZEZpbmRQcmVzZXJ2ZUZvck9iaiIsImxvb2t1cCIsIl9qc29uX3JlcGxhY2VyIiwiX2VuY29kZVF1ZXVlIiwicHJvbWlzZXMiLCJ0aXAiLCJzaGlmdCIsImNhdGNoIiwiZHN0VmFsdWUiLCJzcmNWYWx1ZSIsInByZXYiLCJzaXplIiwicmVmIiwiYXR0cnMiLCJnZXRQcm90b3R5cGVPZiIsImNyZWF0ZVJlZ2lzdHJ5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxXQUFXLEVBQWpCO0FBQUEsTUFBcUJDLFlBQVksRUFBakM7QUFDQSxNQUFNQyxTQUFTLGdCQUFnQixPQUFPQyxPQUF2QixHQUFpQ0EsT0FBakMsR0FBMkNDLEdBQTFEOztBQUVBLE1BQU1DLGNBQU4sU0FBNkJDLFFBQTdCLENBQXNDO0FBQ3BDQyxnQkFBYztBQUNaLFVBQU0sSUFBSUMsS0FBSixDQUFVLHlDQUFWLENBQU47QUFBMEQ7O0FBRTVELFNBQU9DLE1BQVAsQ0FBY0MsT0FBZCxFQUF1QjtBQUNyQkMsYUFBU0MsS0FBVCxHQUFpQkYsV0FBVyxRQUE1QixDQURxQixDQUNnQjs7QUFFckMsVUFBTUcsWUFBVSxJQUFJVCxHQUFKLEVBQWhCO0FBQ0EsVUFBTVUsY0FBWSxJQUFJWixNQUFKLEVBQWxCOztBQUVBLFVBQU1hLE9BQU9DLE9BQU9DLGNBQVAsQ0FBc0JOLFFBQXRCLEVBQWdDLEtBQUtPLFNBQXJDLENBQWI7QUFDQUYsV0FBT0csZ0JBQVAsQ0FBMEJKLElBQTFCLEVBQ0UsRUFBSUssZUFBZSxFQUFJQyxPQUFPUixVQUFVUyxHQUFWLENBQWNDLElBQWQsQ0FBbUJWLFNBQW5CLENBQVgsRUFBbkIsRUFDSVcsaUJBQWlCLEVBQUlILE9BQU9QLFlBQVlRLEdBQVosQ0FBZ0JDLElBQWhCLENBQXFCVCxXQUFyQixDQUFYLEVBRHJCLEVBRUlXLGFBQWEsRUFBSUosT0FBT0ksV0FBWCxFQUZqQixFQURGOztBQU1BVixTQUFLVyxhQUFMLENBQW1CMUIsUUFBbkIsRUFBNkJDLFNBQTdCO0FBQ0EsV0FBT2MsSUFBUDs7QUFFQSxhQUFTSixRQUFULEdBQW9CO0FBQ2xCLGFBQU9JLEtBQUtKLFFBQUwsQ0FBY2dCLEtBQWQsQ0FBb0JaLElBQXBCLEVBQTBCYSxTQUExQixDQUFQO0FBQTJDOztBQUU3QyxhQUFTSCxXQUFULENBQXFCSSxLQUFyQixFQUE0QkMsS0FBNUIsRUFBbUNDLFFBQW5DLEVBQTZDO0FBQzNDbEIsZ0JBQVVtQixHQUFWLENBQWNILE1BQU1JLElBQXBCLEVBQTBCSixLQUExQjtBQUNBLGFBQU87QUFDSEssY0FBTSxHQUFHSixLQUFULEVBQWdCO0FBQ2QsZUFBSSxNQUFNSyxJQUFWLElBQWtCTCxLQUFsQixFQUEwQjtBQUN4QixnQkFBR0ssSUFBSCxFQUFVO0FBQUN0Qix3QkFBVW1CLEdBQVYsQ0FBY0csSUFBZCxFQUFvQk4sS0FBcEI7QUFBMEI7QUFBQTtBQUN2QyxpQkFBTyxJQUFQO0FBQVcsU0FKVixFQUtITyxNQUFNLEdBQUdMLFFBQVQsRUFBbUI7QUFDakIsZUFBSSxNQUFNSSxJQUFWLElBQWtCSixRQUFsQixFQUE2QjtBQUMzQixnQkFBRyxRQUFRSSxJQUFYLEVBQWtCO0FBQUNyQiwwQkFBWWtCLEdBQVosQ0FBZ0JHLElBQWhCLEVBQXNCTixLQUF0QjtBQUE0QjtBQUFBO0FBQ2pELGlCQUFPLElBQVA7QUFBVyxTQVJWLEVBQVA7QUFRaUI7QUFBQTs7QUFHckJILGdCQUFjMUIsUUFBZCxFQUF3QkMsU0FBeEIsRUFBbUM7QUFDakMsU0FDR1UsUUFESCxDQUNjLEVBQUNzQixNQUFNLFFBQVA7QUFDUkksYUFBT0MsR0FBUCxFQUFZVCxLQUFaLEVBQW1CO0FBQUdiLGVBQU91QixNQUFQLENBQWNELEdBQWQsRUFBbUJULE1BQU1XLElBQXpCO0FBQThCLE9BRDVDLEVBRGQsRUFHR0osS0FISCxDQUdXcEMsUUFIWDs7QUFLQSxTQUNHVyxRQURILENBQ2MsRUFBQ3NCLE1BQU0sUUFBUDtBQUNSUSxlQUFTQyxRQUFULEVBQW1CO0FBQUcsZUFBTyxFQUFJQyxHQUFHRCxTQUFTRSxLQUFULEVBQVAsRUFBUDtBQUE4QixPQUQ1QyxFQUVSQyxLQUFLaEIsS0FBTCxFQUFZO0FBQUcsZUFBTyxFQUFQO0FBQVMsT0FGaEIsRUFHUlEsT0FBT0ssUUFBUCxFQUFpQmIsS0FBakIsRUFBd0I7QUFDdEJhLGlCQUFTSSxJQUFULENBQWNuQixLQUFkLENBQW9CZSxRQUFwQixFQUE4QmIsTUFBTVcsSUFBTixDQUFXRyxDQUF6QztBQUEyQyxPQUpyQyxFQURkLEVBTUdQLEtBTkgsQ0FNV25DLFNBTlg7QUFNb0I7O0FBRXRCVSxXQUFTb0MsV0FBVCxFQUFzQjtBQUNwQixRQUFHLFVBQVVBLFdBQVYsSUFBeUJBLFlBQVlWLE1BQXhDLEVBQWlEO0FBQy9DLGFBQU8sS0FBS1csZUFBTCxDQUFxQkQsV0FBckIsQ0FBUDtBQUF3Qzs7QUFFMUMsUUFBSUUsR0FBSjtBQUNBLFFBQUdDLGNBQWNILFlBQVk3QixTQUE3QixFQUF5QztBQUN2QytCLFlBQU1GLFlBQVk3QixTQUFaLENBQXNCLEtBQUtOLEtBQTNCLENBQU47QUFDQSxVQUFHc0MsY0FBY0QsR0FBakIsRUFBdUI7QUFDckIsWUFBRyxlQUFlLE9BQU9BLEdBQXpCLEVBQStCO0FBQzdCQSxnQkFBTUEsSUFBSUUsSUFBSixDQUFTSixZQUFZN0IsU0FBckIsRUFBZ0MsSUFBaEMsQ0FBTjtBQUNBLGNBQUcsUUFBUStCLEdBQVgsRUFBaUI7QUFBQztBQUFNO0FBQUE7QUFDMUIsWUFBRyxhQUFhLE9BQU9BLEdBQXZCLEVBQTZCO0FBQzNCLGlCQUFPLEtBQUtHLGFBQUwsQ0FBbUJILEdBQW5CLEVBQXdCRixXQUF4QixDQUFQO0FBQTJDO0FBQUE7QUFBQTs7QUFFakRFLFVBQU1GLFlBQVksS0FBS25DLEtBQWpCLENBQU47QUFDQSxRQUFHc0MsY0FBY0QsR0FBakIsRUFBdUI7QUFDckIsVUFBRyxlQUFlLE9BQU9BLEdBQXpCLEVBQStCO0FBQzdCQSxjQUFNQSxJQUFJRSxJQUFKLENBQVNKLFdBQVQsRUFBc0IsSUFBdEIsQ0FBTjtBQUNBLFlBQUcsUUFBUUUsR0FBWCxFQUFpQjtBQUFDO0FBQU07QUFBQTtBQUMxQixVQUFHLGFBQWEsT0FBT0EsR0FBdkIsRUFBNkI7QUFDM0IsZUFBTyxLQUFLSSxhQUFMLENBQW1CSixHQUFuQixFQUF3QkYsWUFBWTdCLFNBQVosSUFBeUI2QixXQUFqRCxFQUNKWCxLQURJLENBQ0VXLFdBREYsQ0FBUDtBQUNxQjtBQUFBOztBQUV6QixVQUFNLElBQUlPLFNBQUosQ0FBZSwwQ0FBZixDQUFOO0FBQStEOztBQUVqRU4sa0JBQWdCbkIsS0FBaEIsRUFBdUI7QUFDckI7QUFDRSxZQUFNSSxPQUFPSixNQUFNSSxJQUFuQjtBQUNBLFVBQUcsYUFBYSxPQUFPQSxJQUFwQixJQUE0QixTQUFTQSxJQUFyQyxJQUE2QyxVQUFVQSxJQUF2RCxJQUErRCxTQUFTQSxJQUEzRSxFQUFrRjtBQUNoRixjQUFNLElBQUlxQixTQUFKLENBQWlCLHlCQUFqQixDQUFOO0FBQStDOztBQUVqRCxVQUFHekIsTUFBTWdCLElBQU4sSUFBYyxlQUFlLE9BQU9oQixNQUFNZ0IsSUFBN0MsRUFBb0Q7QUFDbEQsY0FBTSxJQUFJUyxTQUFKLENBQWdCLDJCQUFoQixDQUFOO0FBQWlEOztBQUVuRCxVQUFHLGVBQWUsT0FBT3pCLE1BQU1RLE1BQS9CLEVBQXdDO0FBQ3RDLGNBQU0sSUFBSWlCLFNBQUosQ0FBZ0IsNkJBQWhCLENBQU47QUFBbUQ7O0FBRXJELFVBQUd6QixNQUFNWSxRQUFOLElBQWtCLGVBQWUsT0FBT1osTUFBTVksUUFBakQsRUFBNEQ7QUFDMUQsY0FBTSxJQUFJYSxTQUFKLENBQWdCLDJDQUFoQixDQUFOO0FBQWlFO0FBQUE7O0FBRXJFLFdBQU8sS0FBSzdCLFdBQUwsQ0FBaUJJLEtBQWpCLENBQVA7QUFBOEI7O0FBRWhDdUIsZ0JBQWNuQixJQUFkLEVBQW9Cc0IsS0FBcEIsRUFBMkI7QUFDekIsV0FBTyxLQUNKUCxlQURJLENBQ2MsRUFBQ2YsSUFBRDtBQUNqQkksYUFBT0MsR0FBUCxFQUFZVCxLQUFaLEVBQW1CO0FBQ2pCUyxjQUFNdEIsT0FBT3VCLE1BQVAsQ0FBY0QsR0FBZCxFQUFtQlQsTUFBTVcsSUFBekIsQ0FBTjtBQUNBeEIsZUFBT0MsY0FBUCxDQUFzQnFCLEdBQXRCLEVBQTJCaUIsTUFBTXJDLFNBQWpDO0FBQTJDLE9BSDVCLEVBRGQsRUFLSmtCLEtBTEksQ0FLRW1CLEtBTEYsRUFLU0EsTUFBTXJDLFNBTGYsQ0FBUDtBQUtnQzs7QUFFbENtQyxnQkFBY3BCLElBQWQsRUFBb0J1QixLQUFwQixFQUEyQjtBQUN6QixXQUFPLEtBQ0pSLGVBREksQ0FDYyxFQUFDZixJQUFEO0FBQ2pCSSxhQUFPQyxHQUFQLEVBQVlULEtBQVosRUFBbUI7QUFDakJTLGNBQU10QixPQUFPdUIsTUFBUCxDQUFjRCxHQUFkLEVBQW1CVCxNQUFNVyxJQUF6QixDQUFOO0FBQ0F4QixlQUFPQyxjQUFQLENBQXNCcUIsR0FBdEIsRUFBMkJrQixLQUEzQjtBQUFpQyxPQUhsQixFQURkLEVBS0pwQixLQUxJLENBS0VvQixLQUxGLENBQVA7QUFLZTs7QUFHakJDLFNBQU9DLE9BQVAsRUFBZ0JDLEdBQWhCLEVBQXFCO0FBQ25CLFFBQUcsUUFBUUEsR0FBWCxFQUFpQjtBQUFDQSxZQUFNLEVBQU47QUFBUTtBQUMxQixVQUFNL0MsUUFBTSxLQUFLQSxLQUFqQjtBQUFBLFVBQXdCUSxnQkFBYyxLQUFLQSxhQUEzQzs7QUFFQSxVQUFNd0MsUUFBTSxFQUFaO0FBQUEsVUFBZ0JDLFFBQU0sSUFBSXpELEdBQUosRUFBdEI7QUFDQTBELFNBQUtDLEtBQUwsQ0FBV0wsT0FBWCxFQUFvQk0sWUFBcEI7O0FBRUEsVUFBTUMsT0FBSyxJQUFJL0QsTUFBSixFQUFYO0FBQ0E0RCxTQUFLQyxLQUFMLENBQVdMLE9BQVgsRUFBb0JRLGFBQXBCOztBQUVBLFVBQU1DLE9BQU8sRUFBYjtBQUNBLFVBQU1DLFNBQVNDLFFBQVFDLE9BQVIsR0FBa0JDLElBQWxCLENBQXlCLE1BQ3RDWCxNQUFNWSxPQUFOLEdBQWdCQyxHQUFoQixDQUFzQjVDLFNBQVM7QUFDN0JBLFlBQU1zQyxJQUFOLEdBQWFBLElBQWI7QUFDQSxhQUFPdEMsTUFBTTZDLE9BQU4sQ0FBY3JDLE1BQWQsQ0FBcUJSLE1BQU1TLEdBQTNCLEVBQWdDVCxLQUFoQyxFQUF1QzhCLEdBQXZDLENBQVA7QUFBa0QsS0FGcEQsQ0FEYSxDQUFmOztBQUtBUSxTQUFLUSxPQUFMLEdBQWVQLE9BQU9HLElBQVAsQ0FBY0ssT0FBT0EsSUFBSUMsTUFBekIsQ0FBZjtBQUNBVixTQUFLVyxRQUFMLEdBQWdCVixPQUFPRyxJQUFQLENBQWNLLE9BQzVCUCxRQUFRVSxHQUFSLENBQVlILEdBQVosRUFBaUJMLElBQWpCLENBQXdCSyxPQUFPQSxJQUFJQyxNQUFuQyxDQURjLENBQWhCOztBQUdBVixTQUFLYSxJQUFMLEdBQVliLEtBQUtXLFFBQUwsQ0FBY1AsSUFBZCxDQUFxQixNQUFNO0FBQ3JDLFlBQU0sRUFBQ2pDLEdBQUQsRUFBTTJDLE9BQU4sS0FBaUJwQixNQUFNdkMsR0FBTixDQUFVLENBQVYsQ0FBdkI7QUFDQSxhQUFPNEIsY0FBYytCLE9BQWQsR0FBd0IzQyxHQUF4QixHQUNIMkMsUUFBUVYsSUFBUixDQUFlVyxPQUNiQSxRQUFRaEMsU0FBUixHQUFvQmdDLEdBQXBCLEdBQTBCNUMsR0FENUIsQ0FESjtBQUVtQyxLQUp6QixDQUFaO0FBS0EsV0FBTzZCLEtBQUthLElBQVo7O0FBR0EsYUFBU2hCLFlBQVQsQ0FBc0JtQixHQUF0QixFQUEyQjlELEtBQTNCLEVBQWtDO0FBQ2hDLFVBQUdULFVBQVV1RSxHQUFiLEVBQW1CO0FBQ2pCLFlBQUcsYUFBYSxPQUFPOUQsS0FBdkIsRUFBK0IsRUFBL0IsTUFDSyxJQUFHK0QsTUFBTUMsT0FBTixDQUFjaEUsS0FBZCxDQUFILEVBQTBCO0FBQzdCLGlCQUFPLEtBQUtULEtBQUwsQ0FBUDs7QUFFQSxnQkFBTSxDQUFDcUIsSUFBRCxFQUFPcUQsR0FBUCxJQUFjakUsS0FBcEI7QUFDQSxnQkFBTXFELFVBQVV0RCxjQUFjYSxJQUFkLENBQWhCO0FBQ0EsY0FBR2lCLGNBQWN3QixPQUFqQixFQUEyQjtBQUN6QixrQkFBTSxJQUFJYSxlQUFKLENBQXFCLHdDQUF1Q3RELElBQUssR0FBakUsQ0FBTjtBQUEwRTs7QUFFNUUsZ0JBQU1KLFFBQVUsRUFBQ0ksSUFBRCxFQUFPcUQsR0FBUCxFQUFZWixPQUFaLEVBQXFCbEMsTUFBTSxJQUEzQixFQUFoQjs7QUFFQVgsZ0JBQU1TLEdBQU4sR0FBWW9DLFFBQVE3QixJQUFSLEdBQ1I2QixRQUFRN0IsSUFBUixDQUFhaEIsS0FBYixFQUFvQjhCLEdBQXBCLENBRFEsR0FFUjNDLE9BQU9QLE1BQVAsQ0FBYyxJQUFkLENBRko7O0FBSUFvRCxnQkFBTTdCLEdBQU4sQ0FBVXNELEdBQVYsRUFBZXpELEtBQWY7QUFDQStCLGdCQUFNZCxJQUFOLENBQVdqQixLQUFYO0FBQWlCO0FBQ25CO0FBQU07O0FBRVIsYUFBT1IsS0FBUDtBQUFZOztBQUdkLGFBQVM2QyxhQUFULENBQXVCaUIsR0FBdkIsRUFBNEI5RCxLQUE1QixFQUFtQztBQUNqQyxVQUFHVCxVQUFVdUUsR0FBYixFQUFtQjtBQUNqQixZQUFHLGFBQWEsT0FBTzlELEtBQXZCLEVBQStCO0FBQzdCNEMsZUFBS2pDLEdBQUwsQ0FBVyxJQUFYLEVBQWlCNkIsTUFBTXZDLEdBQU4sQ0FBVUQsS0FBVixFQUFpQmlCLEdBQWxDO0FBQXFDLFNBRHZDLE1BR0ssSUFBRzhDLE1BQU1DLE9BQU4sQ0FBY2hFLEtBQWQsQ0FBSCxFQUEwQjtBQUM3QixnQkFBTVEsUUFBUWdDLE1BQU12QyxHQUFOLENBQVVELE1BQU0sQ0FBTixDQUFWLENBQWQ7QUFDQVEsZ0JBQU1XLElBQU4sR0FBYSxJQUFiO0FBQ0F5QixlQUFLakMsR0FBTCxDQUFXLElBQVgsRUFBaUJILE1BQU1TLEdBQXZCO0FBQTBCO0FBQzVCO0FBQU0sT0FSUixNQVVLLElBQUcsU0FBU2pCLEtBQVQsSUFBa0IsYUFBYSxPQUFPQSxLQUF6QyxFQUFpRDtBQUNwRCxlQUFPQSxLQUFQO0FBQVk7O0FBRWQsWUFBTTZELE1BQU1qQixLQUFLM0MsR0FBTCxDQUFTRCxLQUFULENBQVo7QUFDQSxhQUFPNkQsUUFBUWhDLFNBQVIsR0FBb0JnQyxHQUFwQixHQUEwQjdELEtBQWpDO0FBQXNDO0FBQUE7O0FBRzFDbUUsU0FBT0MsUUFBUCxFQUFpQjlCLEdBQWpCLEVBQXNCO0FBQ3BCLFVBQU1NLE9BQU8sRUFBYjtBQUNBLFVBQU1nQixVQUFVLEtBQUtTLGFBQUwsQ0FBcUJELFFBQXJCLEVBQStCOUIsR0FBL0IsRUFBb0MsQ0FBQ2dDLEdBQUQsRUFBTTlELEtBQU4sS0FBZ0I7QUFDbEVvQyxXQUFLcEMsTUFBTXlELEdBQVgsSUFBa0J6RCxNQUFNK0QsT0FBeEI7QUFBK0IsS0FEakIsQ0FBaEI7O0FBR0EsVUFBTVQsTUFBTXJCLEtBQUsrQixTQUFMLENBQWtCLEdBQUUsS0FBS2pGLEtBQU0sTUFBL0IsQ0FBWjtBQUNBLFdBQU9xRSxRQUFRVixJQUFSLENBQWUsTUFDbkIsSUFBR1ksR0FBSSxVQUFTbEIsS0FBSzZCLElBQUwsQ0FBVSxPQUFWLENBQW1CLE9BRC9CLENBQVA7QUFDNEM7O0FBRzlDSixnQkFBY0QsUUFBZCxFQUF3QjlCLEdBQXhCLEVBQTZCb0MsUUFBN0IsRUFBdUM7QUFDckMsUUFBRyxlQUFlLE9BQU9wQyxHQUF6QixFQUErQjtBQUM3Qm9DLGlCQUFXcEMsR0FBWCxDQUFnQkEsTUFBTSxFQUFOO0FBQVEsS0FEMUIsTUFFSyxJQUFHLFFBQVFBLEdBQVgsRUFBaUI7QUFDcEJBLFlBQU0sRUFBTjtBQUFROztBQUVWLFVBQU0vQyxRQUFNLEtBQUtBLEtBQWpCO0FBQUEsVUFBd0JZLGtCQUFnQixLQUFLQSxlQUE3QztBQUFBLFVBQThEd0UsZ0JBQWMsS0FBS0Msd0JBQUwsRUFBNUU7O0FBRUEsVUFBTXJDLFFBQU0sRUFBWjtBQUFBLFVBQWdCc0MsU0FBTyxJQUFJOUYsR0FBSixFQUF2QjtBQUNBMEQsU0FBSytCLFNBQUwsQ0FBZUosUUFBZixFQUF5QlUsY0FBekI7O0FBRUEsV0FBT0MsY0FBUDs7QUFFQSxhQUFTQSxZQUFULEdBQXdCO0FBQ3RCLFVBQUcsTUFBTXhDLE1BQU1pQixNQUFmLEVBQXdCO0FBQ3RCLGVBQU9SLFFBQVFDLE9BQVIsRUFBUDtBQUF3Qjs7QUFFMUIsWUFBTStCLFdBQVcsRUFBakI7QUFDQSxhQUFNLE1BQU16QyxNQUFNaUIsTUFBbEIsRUFBMkI7QUFDekIsY0FBTXlCLE1BQU0xQyxNQUFNMkMsS0FBTixFQUFaO0FBQUEsY0FBMkJqQixNQUFNZ0IsSUFBSWhCLEdBQXJDO0FBQ0FlLGlCQUFTdkQsSUFBVCxDQUNFd0QsSUFDRy9CLElBREgsQ0FDVS9CLFFBQVE7QUFDZCxnQkFBTW9ELFVBQVU5QixLQUFLK0IsU0FBTCxDQUFlckQsSUFBZixFQUFxQjJELGNBQXJCLENBQWhCO0FBQ0EsaUJBQU9KLFNBQVcsSUFBWCxFQUFpQixFQUFFVCxHQUFGLEVBQU85QyxJQUFQLEVBQWFvRCxPQUFiLEVBQWpCLENBQVA7QUFBOEMsU0FIbEQsRUFJR1ksS0FKSCxDQUlXYixPQUFPSSxTQUFTSixHQUFULENBSmxCLENBREY7QUFLaUM7O0FBRW5DLGFBQU90QixRQUFRVSxHQUFSLENBQVlzQixRQUFaLEVBQXNCOUIsSUFBdEIsQ0FBMkI2QixZQUEzQixDQUFQO0FBQStDOztBQUVqRCxhQUFTRCxjQUFULENBQXdCaEIsR0FBeEIsRUFBNkJzQixRQUE3QixFQUF1QztBQUNyQztBQUNBLFlBQU1DLFdBQVcsS0FBS3ZCLEdBQUwsQ0FBakI7O0FBRUEsVUFBR3NCLGFBQWEsSUFBYixJQUFxQixhQUFhLE9BQU9DLFFBQTVDLEVBQXVEO0FBQ3JELGVBQU9ELFFBQVA7QUFBZTs7QUFFakIsWUFBTUUsT0FBT1QsT0FBTzVFLEdBQVAsQ0FBV29GLFFBQVgsQ0FBYjtBQUNBLFVBQUd4RCxjQUFjeUQsSUFBakIsRUFBd0I7QUFDdEIsZUFBT0EsSUFBUCxDQURzQixDQUNWO0FBQWdELE9BRTlELElBQUk5RSxRQUFRbUUsY0FBY1UsUUFBZCxDQUFaO0FBQ0EsVUFBR3hELGNBQWNyQixLQUFqQixFQUF5QjtBQUN2QjtBQUNBLFlBQUc0RCxhQUFhaUIsUUFBaEIsRUFBMkI7QUFDekIsaUJBQU9ELFFBQVAsQ0FEeUIsQ0FDVDtBQUF3QjtBQUMxQztBQUNBNUUsZ0JBQVFMLGdCQUNONEQsTUFBTUMsT0FBTixDQUFjb0IsUUFBZCxJQUEwQnhHLFNBQTFCLEdBQXNDRCxRQURoQyxDQUFSO0FBQ2dEOztBQUVsRDtBQUNBLFlBQU1zRixNQUFNWSxPQUFPVSxJQUFuQjtBQUNBLFlBQU1DLE1BQU0sRUFBQyxDQUFDakcsS0FBRCxHQUFTMEUsR0FBVixFQUFaO0FBQ0FZLGFBQU9sRSxHQUFQLENBQVcwRSxRQUFYLEVBQXFCRzs7QUFFckI7QUFGQSxRQUdBLE1BQU1yRSxPQUFPLEVBQUMsQ0FBQzVCLEtBQUQsR0FBUyxDQUFDaUIsTUFBTUksSUFBUCxFQUFhcUQsR0FBYixDQUFWLEVBQWI7QUFDQSxZQUFNTCxVQUFVWixRQUNiQyxPQURhLENBQ0h6QyxNQUFNWSxRQUFOLEdBQWlCWixNQUFNWSxRQUFOLENBQWVnRSxRQUFmLEVBQXlCQyxRQUF6QixFQUFtQy9DLEdBQW5DLENBQWpCLEdBQTJEOEMsUUFEeEQsRUFFYmxDLElBRmEsQ0FFTnVDLFNBQVM5RixPQUFPdUIsTUFBUCxDQUFjQyxJQUFkLEVBQW9Cc0UsS0FBcEIsQ0FGSCxDQUFoQjs7QUFJQTdCLGNBQVFLLEdBQVIsR0FBY0EsR0FBZDtBQUNBMUIsWUFBTWQsSUFBTixDQUFhbUMsT0FBYjtBQUNBLGFBQU80QixHQUFQO0FBQVU7QUFBQTs7QUFFZFosNkJBQTJCO0FBQ3pCLFVBQU16RSxrQkFBa0IsS0FBS0EsZUFBN0I7QUFDQSxXQUFPLFVBQVNjLEdBQVQsRUFBYztBQUNuQixVQUFJVCxRQUFRTCxnQkFBZ0JjLEdBQWhCLENBQVo7QUFDQSxVQUFHWSxjQUFjckIsS0FBakIsRUFBeUI7QUFDdkIsZUFBT0EsS0FBUDtBQUFZOztBQUVkQSxjQUFRTCxnQkFBZ0JjLElBQUkvQixXQUFwQixDQUFSO0FBQ0EsVUFBRzJDLGNBQWNyQixLQUFqQixFQUF5QjtBQUN2QixlQUFPQSxLQUFQO0FBQVk7O0FBRWQsVUFBSTJCLFFBQVFsQixHQUFaO0FBQ0EsYUFBTSxVQUFXa0IsUUFBUXhDLE9BQU8rRixjQUFQLENBQXNCdkQsS0FBdEIsQ0FBbkIsQ0FBTixFQUF3RDtBQUN0RCxZQUFJM0IsUUFBUUwsZ0JBQWdCZ0MsS0FBaEIsQ0FBWjtBQUNBLFlBQUdOLGNBQWNyQixLQUFqQixFQUF5QjtBQUN2QixpQkFBT0EsS0FBUDtBQUFZO0FBQUE7QUFBQSxLQWJsQjtBQWFrQjtBQTVRZ0I7O0FBK1F0QyxNQUFNMEQsZUFBTixTQUE4Qi9FLEtBQTlCLENBQW9DOztBQUVwQyxNQUFNd0csaUJBQWlCM0csZUFBZUksTUFBZixDQUFzQmMsSUFBdEIsQ0FBMkJsQixjQUEzQixDQUF2Qjs7QUFFQTRHLE9BQU9DLE9BQVAsR0FBaUJBLFVBQVVGLGdCQUEzQjtBQUNBaEcsT0FBT3VCLE1BQVAsQ0FBZ0IyRSxPQUFoQixFQUNJLEVBQUk3RyxjQUFKLEVBQW9Ca0YsZUFBcEI7QUFDSXlCLGdCQURKLEVBQ29CdkcsUUFBUXVHLGNBRDVCLEVBREoiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCByb290X29iaiA9IHt9LCByb290X2xpc3QgPSBbXVxuY29uc3QgT2JqTWFwID0gJ3VuZGVmaW5lZCcgIT09IHR5cGVvZiBXZWFrTWFwID8gV2Vha01hcCA6IE1hcFxuXG5jbGFzcyBSZXZpdGFsaXphdGlvbiBleHRlbmRzIEZ1bmN0aW9uIDo6XG4gIGNvbnN0cnVjdG9yKCkgOjpcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZSB0aGUgc3RhdGljIC5jcmVhdGUoKSBpbnN0ZWFkIG9mIG5ldycpXG5cbiAgc3RhdGljIGNyZWF0ZSh0b2tlbl9wKSA6OlxuICAgIHJlZ2lzdGVyLnRva2VuID0gdG9rZW5fcCB8fCAnXFx1MDM5RScgLy8gJ86eJ1xuXG4gICAgY29uc3QgbHV0UmV2aXZlPW5ldyBNYXAoKVxuICAgIGNvbnN0IGx1dFByZXNlcnZlPW5ldyBPYmpNYXAoKVxuXG4gICAgY29uc3Qgc2VsZiA9IE9iamVjdC5zZXRQcm90b3R5cGVPZihyZWdpc3RlciwgdGhpcy5wcm90b3R5cGUpXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMgQCBzZWxmLFxuICAgICAgQHt9IGxvb2t1cFJldml2ZXI6IEB7fSB2YWx1ZTogbHV0UmV2aXZlLmdldC5iaW5kKGx1dFJldml2ZSlcbiAgICAgICAgLCBsb29rdXBQcmVzZXJ2ZXI6IEB7fSB2YWx1ZTogbHV0UHJlc2VydmUuZ2V0LmJpbmQobHV0UHJlc2VydmUpXG4gICAgICAgICwgX3NldFJldml2ZXI6IEB7fSB2YWx1ZTogX3NldFJldml2ZXJcblxuXG4gICAgc2VsZi5pbml0UmVnaXN0ZXJ5KHJvb3Rfb2JqLCByb290X2xpc3QpXG4gICAgcmV0dXJuIHNlbGZcblxuICAgIGZ1bmN0aW9uIHJlZ2lzdGVyKCkgOjpcbiAgICAgIHJldHVybiBzZWxmLnJlZ2lzdGVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cylcblxuICAgIGZ1bmN0aW9uIF9zZXRSZXZpdmVyKGVudHJ5LCBraW5kcywgbWF0Y2hlcnMpIDo6XG4gICAgICBsdXRSZXZpdmUuc2V0KGVudHJ5LmtpbmQsIGVudHJ5KVxuICAgICAgcmV0dXJuIDo6XG4gICAgICAgICAgYWxpYXMoLi4ua2luZHMpIDo6XG4gICAgICAgICAgICBmb3IgY29uc3QgZWFjaCBvZiBraW5kcyA6OlxuICAgICAgICAgICAgICBpZiBlYWNoIDo6IGx1dFJldml2ZS5zZXQoZWFjaCwgZW50cnkpXG4gICAgICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgICAsIG1hdGNoKC4uLm1hdGNoZXJzKSA6OlxuICAgICAgICAgICAgZm9yIGNvbnN0IGVhY2ggb2YgbWF0Y2hlcnMgOjpcbiAgICAgICAgICAgICAgaWYgbnVsbCAhPSBlYWNoIDo6IGx1dFByZXNlcnZlLnNldChlYWNoLCBlbnRyeSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzXG5cblxuICBpbml0UmVnaXN0ZXJ5KHJvb3Rfb2JqLCByb290X2xpc3QpIDo6XG4gICAgdGhpc1xuICAgICAgLnJlZ2lzdGVyIEA6IGtpbmQ6ICd7cm9vdH0nXG4gICAgICAgICwgcmV2aXZlKG9iaiwgZW50cnkpIDo6IE9iamVjdC5hc3NpZ24ob2JqLCBlbnRyeS5ib2R5KVxuICAgICAgLm1hdGNoIEAgcm9vdF9vYmpcblxuICAgIHRoaXNcbiAgICAgIC5yZWdpc3RlciBAOiBraW5kOiAnW3Jvb3RdJ1xuICAgICAgICAsIHByZXNlcnZlKHJvb3RMaXN0KSA6OiByZXR1cm4gQHt9IF86IHJvb3RMaXN0LnNsaWNlKClcbiAgICAgICAgLCBpbml0KGVudHJ5KSA6OiByZXR1cm4gW11cbiAgICAgICAgLCByZXZpdmUocm9vdExpc3QsIGVudHJ5KSA6OlxuICAgICAgICAgICAgcm9vdExpc3QucHVzaC5hcHBseShyb290TGlzdCwgZW50cnkuYm9keS5fKVxuICAgICAgLm1hdGNoIEAgcm9vdF9saXN0XG5cbiAgcmVnaXN0ZXIocmV2aXRhbGl6ZXIpIDo6XG4gICAgaWYgJ2tpbmQnIGluIHJldml0YWxpemVyICYmIHJldml0YWxpemVyLnJldml2ZSA6OlxuICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJSZXZpdmVyKHJldml0YWxpemVyKVxuXG4gICAgbGV0IHRndFxuICAgIGlmIHVuZGVmaW5lZCAhPT0gcmV2aXRhbGl6ZXIucHJvdG90eXBlIDo6XG4gICAgICB0Z3QgPSByZXZpdGFsaXplci5wcm90b3R5cGVbdGhpcy50b2tlbl1cbiAgICAgIGlmIHVuZGVmaW5lZCAhPT0gdGd0IDo6XG4gICAgICAgIGlmICdmdW5jdGlvbicgPT09IHR5cGVvZiB0Z3QgOjpcbiAgICAgICAgICB0Z3QgPSB0Z3QuY2FsbChyZXZpdGFsaXplci5wcm90b3R5cGUsIHRoaXMpXG4gICAgICAgICAgaWYgbnVsbCA9PSB0Z3QgOjogcmV0dXJuXG4gICAgICAgIGlmICdzdHJpbmcnID09PSB0eXBlb2YgdGd0IDo6XG4gICAgICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJDbGFzcyh0Z3QsIHJldml0YWxpemVyKVxuXG4gICAgdGd0ID0gcmV2aXRhbGl6ZXJbdGhpcy50b2tlbl1cbiAgICBpZiB1bmRlZmluZWQgIT09IHRndCA6OlxuICAgICAgaWYgJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIHRndCA6OlxuICAgICAgICB0Z3QgPSB0Z3QuY2FsbChyZXZpdGFsaXplciwgdGhpcylcbiAgICAgICAgaWYgbnVsbCA9PSB0Z3QgOjogcmV0dXJuXG4gICAgICBpZiAnc3RyaW5nJyA9PT0gdHlwZW9mIHRndCA6OlxuICAgICAgICByZXR1cm4gdGhpcy5yZWdpc3RlclByb3RvKHRndCwgcmV2aXRhbGl6ZXIucHJvdG90eXBlIHx8IHJldml0YWxpemVyKVxuICAgICAgICAgIC5tYXRjaChyZXZpdGFsaXplcilcblxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYFVucmVjb2duaXplZCByZXZpdGFsaXphdGlvbiByZWdpc3RyYXRpb25gKVxuXG4gIHJlZ2lzdGVyUmV2aXZlcihlbnRyeSkgOjpcbiAgICA6OlxuICAgICAgY29uc3Qga2luZCA9IGVudHJ5LmtpbmRcbiAgICAgIGlmICdzdHJpbmcnICE9PSB0eXBlb2Yga2luZCAmJiB0cnVlICE9PSBraW5kICYmIGZhbHNlICE9PSBraW5kICYmIG51bGwgIT09IGtpbmQgOjpcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvciBAIGBcImtpbmRcIiBtdXN0IGJlIGEgc3RyaW5nYFxuXG4gICAgICBpZiBlbnRyeS5pbml0ICYmICdmdW5jdGlvbicgIT09IHR5cGVvZiBlbnRyeS5pbml0IDo6XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IgQCAnXCJpbml0XCIgbXVzdCBiZSBhIGZ1bmN0aW9uJ1xuXG4gICAgICBpZiAnZnVuY3Rpb24nICE9PSB0eXBlb2YgZW50cnkucmV2aXZlIDo6XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IgQCAnXCJyZXZpdmVcIiBtdXN0IGJlIGEgZnVuY3Rpb24nXG5cbiAgICAgIGlmIGVudHJ5LnByZXNlcnZlICYmICdmdW5jdGlvbicgIT09IHR5cGVvZiBlbnRyeS5wcmVzZXJ2ZSA6OlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yIEAgJ1wicHJlc2VydmVcIiBtdXN0IGJlIGEgZnVuY3Rpb24gaWYgcHJvdmlkZWQnXG5cbiAgICByZXR1cm4gdGhpcy5fc2V0UmV2aXZlcihlbnRyeSlcblxuICByZWdpc3RlckNsYXNzKGtpbmQsIGtsYXNzKSA6OlxuICAgIHJldHVybiB0aGlzXG4gICAgICAucmVnaXN0ZXJSZXZpdmVyIEA6IGtpbmQsXG4gICAgICAgIHJldml2ZShvYmosIGVudHJ5KSA6OlxuICAgICAgICAgIG9iaiA9IE9iamVjdC5hc3NpZ24ob2JqLCBlbnRyeS5ib2R5KVxuICAgICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihvYmosIGtsYXNzLnByb3RvdHlwZSlcbiAgICAgIC5tYXRjaChrbGFzcywga2xhc3MucHJvdG90eXBlKVxuXG4gIHJlZ2lzdGVyUHJvdG8oa2luZCwgcHJvdG8pIDo6XG4gICAgcmV0dXJuIHRoaXNcbiAgICAgIC5yZWdpc3RlclJldml2ZXIgQDoga2luZCxcbiAgICAgICAgcmV2aXZlKG9iaiwgZW50cnkpIDo6XG4gICAgICAgICAgb2JqID0gT2JqZWN0LmFzc2lnbihvYmosIGVudHJ5LmJvZHkpXG4gICAgICAgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKG9iaiwgcHJvdG8pXG4gICAgICAubWF0Y2gocHJvdG8pXG5cblxuICBkZWNvZGUoYVN0cmluZywgY3R4KSA6OlxuICAgIGlmIG51bGwgPT0gY3R4IDo6IGN0eCA9IHt9XG4gICAgY29uc3QgdG9rZW49dGhpcy50b2tlbiwgbG9va3VwUmV2aXZlcj10aGlzLmxvb2t1cFJldml2ZXJcblxuICAgIGNvbnN0IHF1ZXVlPVtdLCBieU9pZD1uZXcgTWFwKClcbiAgICBKU09OLnBhcnNlKGFTdHJpbmcsIF9qc29uX2NyZWF0ZSlcblxuICAgIGNvbnN0IHJlZnM9bmV3IE9iak1hcCgpXG4gICAgSlNPTi5wYXJzZShhU3RyaW5nLCBfanNvbl9yZXN0b3JlKVxuXG4gICAgY29uc3QgZXZ0cyA9IHt9XG4gICAgY29uc3QgX3N0YXJ0ID0gUHJvbWlzZS5yZXNvbHZlKCkudGhlbiBAICgpID0+XG4gICAgICBxdWV1ZS5yZXZlcnNlKCkubWFwIEAgZW50cnkgPT4gOjpcbiAgICAgICAgZW50cnkuZXZ0cyA9IGV2dHNcbiAgICAgICAgcmV0dXJuIGVudHJ5LnJldml2ZXIucmV2aXZlKGVudHJ5Lm9iaiwgZW50cnksIGN0eClcblxuICAgIGV2dHMuc3RhcnRlZCA9IF9zdGFydC50aGVuIEAgbHN0ID0+IGxzdC5sZW5ndGhcbiAgICBldnRzLmZpbmlzaGVkID0gX3N0YXJ0LnRoZW4gQCBsc3QgPT5cbiAgICAgIFByb21pc2UuYWxsKGxzdCkudGhlbiBAIGxzdCA9PiBsc3QubGVuZ3RoXG5cbiAgICBldnRzLmRvbmUgPSBldnRzLmZpbmlzaGVkLnRoZW4gQCAoKSA9PiA6OlxuICAgICAgY29uc3Qge29iaiwgcHJvbWlzZX0gPSBieU9pZC5nZXQoMClcbiAgICAgIHJldHVybiB1bmRlZmluZWQgPT09IHByb21pc2UgPyBvYmpcbiAgICAgICAgOiBwcm9taXNlLnRoZW4gQCBhbnMgPT5cbiAgICAgICAgICAgIGFucyAhPT0gdW5kZWZpbmVkID8gYW5zIDogb2JqXG4gICAgcmV0dXJuIGV2dHMuZG9uZVxuXG5cbiAgICBmdW5jdGlvbiBfanNvbl9jcmVhdGUoa2V5LCB2YWx1ZSkgOjpcbiAgICAgIGlmIHRva2VuID09PSBrZXkgOjpcbiAgICAgICAgaWYgJ251bWJlcicgPT09IHR5cGVvZiB2YWx1ZSA6OlxuICAgICAgICBlbHNlIGlmIEFycmF5LmlzQXJyYXkodmFsdWUpIDo6XG4gICAgICAgICAgZGVsZXRlIHRoaXNbdG9rZW5dXG5cbiAgICAgICAgICBjb25zdCBba2luZCwgb2lkXSA9IHZhbHVlXG4gICAgICAgICAgY29uc3QgcmV2aXZlciA9IGxvb2t1cFJldml2ZXIoa2luZClcbiAgICAgICAgICBpZiB1bmRlZmluZWQgPT09IHJldml2ZXIgOjpcbiAgICAgICAgICAgIHRocm93IG5ldyBSZXZpdmVyTm90Rm91bmQoYE1pc3NpbmcgcmVnaXN0ZXJlZCByZXZpdmVyIGZvciBraW5kIFwiJHtraW5kfVwiYClcblxuICAgICAgICAgIGNvbnN0IGVudHJ5ID0gQDoga2luZCwgb2lkLCByZXZpdmVyLCBib2R5OiB0aGlzXG5cbiAgICAgICAgICBlbnRyeS5vYmogPSByZXZpdmVyLmluaXRcbiAgICAgICAgICAgID8gcmV2aXZlci5pbml0KGVudHJ5LCBjdHgpXG4gICAgICAgICAgICA6IE9iamVjdC5jcmVhdGUobnVsbClcblxuICAgICAgICAgIGJ5T2lkLnNldChvaWQsIGVudHJ5KVxuICAgICAgICAgIHF1ZXVlLnB1c2goZW50cnkpXG4gICAgICAgIHJldHVyblxuXG4gICAgICByZXR1cm4gdmFsdWVcblxuXG4gICAgZnVuY3Rpb24gX2pzb25fcmVzdG9yZShrZXksIHZhbHVlKSA6OlxuICAgICAgaWYgdG9rZW4gPT09IGtleSA6OlxuICAgICAgICBpZiAnbnVtYmVyJyA9PT0gdHlwZW9mIHZhbHVlIDo6XG4gICAgICAgICAgcmVmcy5zZXQgQCB0aGlzLCBieU9pZC5nZXQodmFsdWUpLm9ialxuXG4gICAgICAgIGVsc2UgaWYgQXJyYXkuaXNBcnJheSh2YWx1ZSkgOjpcbiAgICAgICAgICBjb25zdCBlbnRyeSA9IGJ5T2lkLmdldCh2YWx1ZVsxXSlcbiAgICAgICAgICBlbnRyeS5ib2R5ID0gdGhpc1xuICAgICAgICAgIHJlZnMuc2V0IEAgdGhpcywgZW50cnkub2JqXG4gICAgICAgIHJldHVyblxuXG4gICAgICBlbHNlIGlmIG51bGwgPT09IHZhbHVlIHx8ICdvYmplY3QnICE9PSB0eXBlb2YgdmFsdWUgOjpcbiAgICAgICAgcmV0dXJuIHZhbHVlXG5cbiAgICAgIGNvbnN0IGFucyA9IHJlZnMuZ2V0KHZhbHVlKVxuICAgICAgcmV0dXJuIGFucyAhPT0gdW5kZWZpbmVkID8gYW5zIDogdmFsdWVcblxuXG4gIGVuY29kZShhbk9iamVjdCwgY3R4KSA6OlxuICAgIGNvbnN0IHJlZnMgPSBbXVxuICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmVuY29kZU9iamVjdHMgQCBhbk9iamVjdCwgY3R4LCAoZXJyLCBlbnRyeSkgPT4gOjpcbiAgICAgIHJlZnNbZW50cnkub2lkXSA9IGVudHJ5LmNvbnRlbnRcblxuICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5IEAgYCR7dGhpcy50b2tlbn1yZWZzYFxuICAgIHJldHVybiBwcm9taXNlLnRoZW4gQCAoKSA9PlxuICAgICAgYHske2tleX06IFtcXG4gICR7cmVmcy5qb2luKCcsXFxuICAnKX0gXX1cXG5gXG5cblxuICBlbmNvZGVPYmplY3RzKGFuT2JqZWN0LCBjdHgsIGNhbGxiYWNrKSA6OlxuICAgIGlmICdmdW5jdGlvbicgPT09IHR5cGVvZiBjdHggOjpcbiAgICAgIGNhbGxiYWNrID0gY3R4OyBjdHggPSB7fVxuICAgIGVsc2UgaWYgbnVsbCA9PSBjdHggOjpcbiAgICAgIGN0eCA9IHt9XG5cbiAgICBjb25zdCB0b2tlbj10aGlzLnRva2VuLCBsb29rdXBQcmVzZXJ2ZXI9dGhpcy5sb29rdXBQcmVzZXJ2ZXIsIGZpbmRQcmVzZXJ2ZXI9dGhpcy5fYm91bmRGaW5kUHJlc2VydmVGb3JPYmooKVxuXG4gICAgY29uc3QgcXVldWU9W10sIGxvb2t1cD1uZXcgTWFwKClcbiAgICBKU09OLnN0cmluZ2lmeShhbk9iamVjdCwgX2pzb25fcmVwbGFjZXIpXG5cbiAgICByZXR1cm4gX2VuY29kZVF1ZXVlKClcblxuICAgIGZ1bmN0aW9uIF9lbmNvZGVRdWV1ZSgpIDo6XG4gICAgICBpZiAwID09PSBxdWV1ZS5sZW5ndGggOjpcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG5cbiAgICAgIGNvbnN0IHByb21pc2VzID0gW11cbiAgICAgIHdoaWxlIDAgIT09IHF1ZXVlLmxlbmd0aCA6OlxuICAgICAgICBjb25zdCB0aXAgPSBxdWV1ZS5zaGlmdCgpLCBvaWQgPSB0aXAub2lkXG4gICAgICAgIHByb21pc2VzLnB1c2ggQFxuICAgICAgICAgIHRpcFxuICAgICAgICAgICAgLnRoZW4gQCBib2R5ID0+IDo6XG4gICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShib2R5LCBfanNvbl9yZXBsYWNlcilcbiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrIEAgbnVsbCwgeyBvaWQsIGJvZHksIGNvbnRlbnQgfVxuICAgICAgICAgICAgLmNhdGNoIEAgZXJyID0+IGNhbGxiYWNrKGVycilcblxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKF9lbmNvZGVRdWV1ZSlcblxuICAgIGZ1bmN0aW9uIF9qc29uX3JlcGxhY2VyKGtleSwgZHN0VmFsdWUpIDo6XG4gICAgICAvLyBzcmNWYWx1ZSAhPT0gZHN0VmFsdWUgZm9yIG9iamVjdHMgd2l0aCAudG9KU09OKCkgbWV0aG9kc1xuICAgICAgY29uc3Qgc3JjVmFsdWUgPSB0aGlzW2tleV1cblxuICAgICAgaWYgZHN0VmFsdWUgPT09IG51bGwgfHwgJ29iamVjdCcgIT09IHR5cGVvZiBzcmNWYWx1ZSA6OlxuICAgICAgICByZXR1cm4gZHN0VmFsdWVcblxuICAgICAgY29uc3QgcHJldiA9IGxvb2t1cC5nZXQoc3JjVmFsdWUpXG4gICAgICBpZiB1bmRlZmluZWQgIT09IHByZXYgOjpcbiAgICAgICAgcmV0dXJuIHByZXYgLy8gYWxyZWFkeSBzZXJpYWxpemVkIC0tIHJlZmVyZW5jZSBleGlzdGluZyBpdGVtXG5cbiAgICAgIGxldCBlbnRyeSA9IGZpbmRQcmVzZXJ2ZXIoc3JjVmFsdWUpXG4gICAgICBpZiB1bmRlZmluZWQgPT09IGVudHJ5IDo6XG4gICAgICAgIC8vIG5vdCBhIFwic3BlY2lhbFwiIHByZXNlcnZlZCBpdGVtXG4gICAgICAgIGlmIGFuT2JqZWN0ICE9PSBzcmNWYWx1ZSA6OlxuICAgICAgICAgIHJldHVybiBkc3RWYWx1ZSAvLyBzbyBzZXJpYWxpemUgbm9ybWFsbHlcbiAgICAgICAgLy8gYnV0IGl0IGlzIHRoZSByb290LCBzbyBzdG9yZSBhdCBvaWQgMFxuICAgICAgICBlbnRyeSA9IGxvb2t1cFByZXNlcnZlciBAXG4gICAgICAgICAgQXJyYXkuaXNBcnJheShkc3RWYWx1ZSkgPyByb290X2xpc3QgOiByb290X29ialxuXG4gICAgICAvLyByZWdpc3RlciBpZCBmb3Igb2JqZWN0IGFuZCByZXR1cm4gYSBKU09OIHNlcmlhbGl6YWJsZSB2ZXJzaW9uXG4gICAgICBjb25zdCBvaWQgPSBsb29rdXAuc2l6ZVxuICAgICAgY29uc3QgcmVmID0ge1t0b2tlbl06IG9pZH1cbiAgICAgIGxvb2t1cC5zZXQoc3JjVmFsdWUsIHJlZilcblxuICAgICAgLy8gdHJhbnNmb3JtIGxpdmUgb2JqZWN0IGludG8gcHJlc2VydmVkIGZvcm1cbiAgICAgIGNvbnN0IGJvZHkgPSB7W3Rva2VuXTogW2VudHJ5LmtpbmQsIG9pZF19XG4gICAgICBjb25zdCBwcm9taXNlID0gUHJvbWlzZVxuICAgICAgICAucmVzb2x2ZSBAIGVudHJ5LnByZXNlcnZlID8gZW50cnkucHJlc2VydmUoZHN0VmFsdWUsIHNyY1ZhbHVlLCBjdHgpIDogZHN0VmFsdWVcbiAgICAgICAgLnRoZW4gQCBhdHRycyA9PiBPYmplY3QuYXNzaWduKGJvZHksIGF0dHJzKVxuXG4gICAgICBwcm9taXNlLm9pZCA9IG9pZFxuICAgICAgcXVldWUucHVzaCBAIHByb21pc2VcbiAgICAgIHJldHVybiByZWZcblxuICBfYm91bmRGaW5kUHJlc2VydmVGb3JPYmooKSA6OlxuICAgIGNvbnN0IGxvb2t1cFByZXNlcnZlciA9IHRoaXMubG9va3VwUHJlc2VydmVyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgOjpcbiAgICAgIGxldCBlbnRyeSA9IGxvb2t1cFByZXNlcnZlcihvYmopXG4gICAgICBpZiB1bmRlZmluZWQgIT09IGVudHJ5IDo6XG4gICAgICAgIHJldHVybiBlbnRyeVxuXG4gICAgICBlbnRyeSA9IGxvb2t1cFByZXNlcnZlcihvYmouY29uc3RydWN0b3IpXG4gICAgICBpZiB1bmRlZmluZWQgIT09IGVudHJ5IDo6XG4gICAgICAgIHJldHVybiBlbnRyeVxuXG4gICAgICBsZXQgcHJvdG8gPSBvYmpcbiAgICAgIHdoaWxlIG51bGwgIT09IEAgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8pIDo6XG4gICAgICAgIGxldCBlbnRyeSA9IGxvb2t1cFByZXNlcnZlcihwcm90bylcbiAgICAgICAgaWYgdW5kZWZpbmVkICE9PSBlbnRyeSA6OlxuICAgICAgICAgIHJldHVybiBlbnRyeVxuXG5cbmNsYXNzIFJldml2ZXJOb3RGb3VuZCBleHRlbmRzIEVycm9yIDo6XG5cbmNvbnN0IGNyZWF0ZVJlZ2lzdHJ5ID0gUmV2aXRhbGl6YXRpb24uY3JlYXRlLmJpbmQoUmV2aXRhbGl6YXRpb24pXG5cbm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGNyZWF0ZVJlZ2lzdHJ5KClcbk9iamVjdC5hc3NpZ24gQCBleHBvcnRzXG4gICwgQHt9IFJldml0YWxpemF0aW9uLCBSZXZpdmVyTm90Rm91bmRcbiAgICAgICwgY3JlYXRlUmVnaXN0cnksIGNyZWF0ZTogY3JlYXRlUmVnaXN0cnlcbiJdfQ==