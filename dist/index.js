'use strict';

const root_obj = {},
      root_list = [];
const ObjMap = 'undefined' !== typeof WeakMap ? WeakMap : Map;

class Revitalization extends Function {
  constructor() {
    throw new Error('Use the static .create() instead of new');
  }

  static create(token_p) {
    register.token = token_p || '\u039E'; // 'Îž'

    const lutRevive = new Map();
    const lutPreserve = new ObjMap();

    const self = Object.setPrototypeOf(register, this.prototype);
    Object.defineProperties(self, { lookupReviver: { value: lutRevive.get.bind(lutRevive) }, lookupPreserver: { value: lutPreserve.get.bind(lutPreserve) }, _setReviver: { value: _setReviver } });

    self.initRegistery(root_obj, root_list);
    return self;

    function register() {
      return self.register.apply(self, arguments);
    }

    function _setReviver(entry, kinds, matchers) {
      lutRevive.set(entry.kind, entry);
      return {
        alias(...kinds) {
          for (const each of kinds) {
            if (each) {
              lutRevive.set(each, entry);
            }
          }
          return this;
        }, match(...matchers) {
          for (const each of matchers) {
            if (null != each) {
              lutPreserve.set(each, entry);
            }
          }
          return this;
        } };
    }
  }

  initRegistery(root_obj, root_list) {
    this.register({ kind: '{root}',
      revive(obj, entry) {
        Object.assign(obj, entry.body);
      } }).match(root_obj);

    this.register({ kind: '[root]',
      preserve(rootList) {
        return { _: rootList.slice() };
      }, init(entry) {
        return [];
      }, revive(rootList, entry) {
        rootList.push.apply(rootList, entry.body._);
      } }).match(root_list);
  }

  register(revitalizer) {
    if ('kind' in revitalizer && revitalizer.revive) {
      return this.registerReviver(revitalizer);
    }

    let tgt;
    if (undefined !== revitalizer.prototype) {
      tgt = revitalizer.prototype[this.token];
      if (undefined !== tgt) {
        if ('function' === typeof tgt) {
          tgt = tgt.call(revitalizer.prototype, this);
          if (null == tgt) {
            return;
          }
        }
        if ('string' === typeof tgt) {
          return this.registerClass(tgt, revitalizer);
        }
      }
    }

    tgt = revitalizer[this.token];
    if (undefined !== tgt) {
      if ('function' === typeof tgt) {
        tgt = tgt.call(revitalizer, this);
        if (null == tgt) {
          return;
        }
      }
      if ('string' === typeof tgt) {
        return this.registerProto(tgt, revitalizer.prototype || revitalizer).match(revitalizer);
      }
    }

    throw new TypeError(`Unrecognized revitalization registration`);
  }

  registerReviver(entry) {
    {
      const kind = entry.kind;
      if ('string' !== typeof kind && true !== kind && false !== kind && null !== kind) {
        throw new TypeError(`"kind" must be a string`);
      }

      if (entry.init && 'function' !== typeof entry.init) {
        throw new TypeError('"init" must be a function');
      }

      if ('function' !== typeof entry.revive) {
        throw new TypeError('"revive" must be a function');
      }

      if (entry.preserve && 'function' !== typeof entry.preserve) {
        throw new TypeError('"preserve" must be a function if provided');
      }
    }

    return this._setReviver(entry);
  }

  registerClass(kind, klass) {
    return this.registerReviver({ kind,
      revive(obj, entry) {
        obj = Object.assign(obj, entry.body);
        Object.setPrototypeOf(obj, klass.prototype);
      } }).match(klass, klass.prototype);
  }

  registerProto(kind, proto) {
    return this.registerReviver({ kind,
      revive(obj, entry) {
        obj = Object.assign(obj, entry.body);
        Object.setPrototypeOf(obj, proto);
      } }).match(proto);
  }

  decode(aString, ctx) {
    if (null == ctx) {
      ctx = {};
    }
    const token = this.token,
          lookupReviver = this.lookupReviver;

    const queue = [],
          byOid = new Map();
    JSON.parse(aString, _json_create);

    const refs = new ObjMap();
    JSON.parse(aString, _json_restore);

    const done = Promise.resolve().then(() => Promise.all(queue.reverse().map(entry => {
      entry.done = done;
      let ans = entry.reviver.revive(entry.obj, entry, ctx);
      if (0 === entry.oid) {
        console.log('here');
        entry.promise = ans = Promise.resolve(ans);
      }
      return ans;
    })));

    return done.then(() => {
      const { obj, promise } = byOid.get(0);
      return undefined === promise ? obj : promise.then(ans => ans !== undefined ? ans : obj);
    });

    function _json_create(key, value) {
      if (token === key) {
        if ('number' === typeof value) {} else if (Array.isArray(value)) {
          delete this[token];

          const [kind, oid] = value;
          const reviver = lookupReviver(kind);
          if (undefined === reviver) {
            throw new ReviverNotFound(`Missing registered reviver for kind "${kind}"`);
          }

          const entry = { kind, oid, reviver, body: this };

          entry.obj = reviver.init ? reviver.init(entry, ctx) : Object.create(null);

          byOid.set(oid, entry);
          queue.push(entry);
        }
        return;
      }

      return value;
    }

    function _json_restore(key, value) {
      if (token === key) {
        if ('number' === typeof value) {
          refs.set(this, byOid.get(value).obj);
        } else if (Array.isArray(value)) {
          const entry = byOid.get(value[1]);
          entry.body = this;
          refs.set(this, entry.obj);
        }
        return;
      } else if (null === value || 'object' !== typeof value) {
        return value;
      }

      const ans = refs.get(value);
      return ans !== undefined ? ans : value;
    }
  }

  encode(anObject, ctx) {
    const refs = [];
    const promise = this.encodeObjects(anObject, ctx, (err, entry) => {
      refs[entry.oid] = entry.content;
    });

    const key = JSON.stringify(`${this.token}refs`);
    return promise.then(() => `{${key}: [\n  ${refs.join(',\n  ')} ]}\n`);
  }

  encodeObjects(anObject, ctx, callback) {
    if ('function' === typeof ctx) {
      callback = ctx;ctx = {};
    } else if (null == ctx) {
      ctx = {};
    }

    const token = this.token,
          lookupPreserver = this.lookupPreserver,
          findPreserver = this._boundFindPreserveForObj();

    const queue = [],
          lookup = new Map();
    JSON.stringify(anObject, _json_replacer);

    return _encodeQueue();

    function _encodeQueue() {
      if (0 === queue.length) {
        return;
      }

      const promises = [];
      while (0 !== queue.length) {
        const tip = queue.shift(),
              oid = tip.oid;
        promises.push(tip.then(body => {
          const content = JSON.stringify(body, _json_replacer);
          return callback(null, { oid, body, content });
        }).catch(err => callback(err)));
      }

      return Promise.all(promises).then(_encodeQueue);
    }

    function _json_replacer(key, value) {
      if (value === null || 'object' !== typeof value) {
        return value;
      }

      const prev = lookup.get(value);
      if (undefined !== prev) {
        return prev; // already serialized -- reference existing item
      }let entry = findPreserver(value);
      if (undefined === entry) {
        // not a "special" preserved item
        if (anObject !== value) {
          return value; // so serialize normally
        }
        // but it is the root, so store at oid 0
        entry = lookupPreserver(Array.isArray(value) ? root_list : root_obj);
      }

      // register id for object and return a JSON serializable version
      const oid = lookup.size;
      const ref = { [token]: oid };
      lookup.set(value, ref

      // transform live object into preserved form
      );const body = { [token]: [entry.kind, oid] };
      const promise = Promise.resolve(entry.preserve ? entry.preserve(value, ctx) : value).then(attrs => Object.assign(body, attrs));

      promise.oid = oid;
      queue.push(promise);
      return ref;
    }
  }

  _boundFindPreserveForObj() {
    const lookupPreserver = this.lookupPreserver;
    return function (obj) {
      let entry = lookupPreserver(obj);
      if (undefined !== entry) {
        return entry;
      }

      entry = lookupPreserver(obj.constructor);
      if (undefined !== entry) {
        return entry;
      }

      let proto = obj;
      while (null !== (proto = Object.getPrototypeOf(proto))) {
        let entry = lookupPreserver(proto);
        if (undefined !== entry) {
          return entry;
        }
      }
    };
  }
}

class ReviverNotFound extends Error {}

const createRegistry = Revitalization.create.bind(Revitalization);

module.exports = exports = createRegistry();
Object.assign(exports, { Revitalization, ReviverNotFound,
  createRegistry, create: createRegistry });
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NvZGUvaW5kZXguanMiXSwibmFtZXMiOlsicm9vdF9vYmoiLCJyb290X2xpc3QiLCJPYmpNYXAiLCJXZWFrTWFwIiwiTWFwIiwiUmV2aXRhbGl6YXRpb24iLCJGdW5jdGlvbiIsImNvbnN0cnVjdG9yIiwiRXJyb3IiLCJjcmVhdGUiLCJ0b2tlbl9wIiwicmVnaXN0ZXIiLCJ0b2tlbiIsImx1dFJldml2ZSIsImx1dFByZXNlcnZlIiwic2VsZiIsIk9iamVjdCIsInNldFByb3RvdHlwZU9mIiwicHJvdG90eXBlIiwiZGVmaW5lUHJvcGVydGllcyIsImxvb2t1cFJldml2ZXIiLCJ2YWx1ZSIsImdldCIsImJpbmQiLCJsb29rdXBQcmVzZXJ2ZXIiLCJfc2V0UmV2aXZlciIsImluaXRSZWdpc3RlcnkiLCJhcHBseSIsImFyZ3VtZW50cyIsImVudHJ5Iiwia2luZHMiLCJtYXRjaGVycyIsInNldCIsImtpbmQiLCJhbGlhcyIsImVhY2giLCJtYXRjaCIsInJldml2ZSIsIm9iaiIsImFzc2lnbiIsImJvZHkiLCJwcmVzZXJ2ZSIsInJvb3RMaXN0IiwiXyIsInNsaWNlIiwiaW5pdCIsInB1c2giLCJyZXZpdGFsaXplciIsInJlZ2lzdGVyUmV2aXZlciIsInRndCIsInVuZGVmaW5lZCIsImNhbGwiLCJyZWdpc3RlckNsYXNzIiwicmVnaXN0ZXJQcm90byIsIlR5cGVFcnJvciIsImtsYXNzIiwicHJvdG8iLCJkZWNvZGUiLCJhU3RyaW5nIiwiY3R4IiwicXVldWUiLCJieU9pZCIsIkpTT04iLCJwYXJzZSIsIl9qc29uX2NyZWF0ZSIsInJlZnMiLCJfanNvbl9yZXN0b3JlIiwiZG9uZSIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsImFsbCIsInJldmVyc2UiLCJtYXAiLCJhbnMiLCJyZXZpdmVyIiwib2lkIiwiY29uc29sZSIsImxvZyIsInByb21pc2UiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJSZXZpdmVyTm90Rm91bmQiLCJlbmNvZGUiLCJhbk9iamVjdCIsImVuY29kZU9iamVjdHMiLCJlcnIiLCJjb250ZW50Iiwic3RyaW5naWZ5Iiwiam9pbiIsImNhbGxiYWNrIiwiZmluZFByZXNlcnZlciIsIl9ib3VuZEZpbmRQcmVzZXJ2ZUZvck9iaiIsImxvb2t1cCIsIl9qc29uX3JlcGxhY2VyIiwiX2VuY29kZVF1ZXVlIiwibGVuZ3RoIiwicHJvbWlzZXMiLCJ0aXAiLCJzaGlmdCIsImNhdGNoIiwicHJldiIsInNpemUiLCJyZWYiLCJhdHRycyIsImdldFByb3RvdHlwZU9mIiwiY3JlYXRlUmVnaXN0cnkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLFdBQVcsRUFBakI7QUFBQSxNQUFxQkMsWUFBWSxFQUFqQztBQUNBLE1BQU1DLFNBQVMsZ0JBQWdCLE9BQU9DLE9BQXZCLEdBQWlDQSxPQUFqQyxHQUEyQ0MsR0FBMUQ7O0FBRUEsTUFBTUMsY0FBTixTQUE2QkMsUUFBN0IsQ0FBc0M7QUFDcENDLGdCQUFjO0FBQ1osVUFBTSxJQUFJQyxLQUFKLENBQVUseUNBQVYsQ0FBTjtBQUEwRDs7QUFFNUQsU0FBT0MsTUFBUCxDQUFjQyxPQUFkLEVBQXVCO0FBQ3JCQyxhQUFTQyxLQUFULEdBQWlCRixXQUFXLFFBQTVCLENBRHFCLENBQ2dCOztBQUVyQyxVQUFNRyxZQUFVLElBQUlULEdBQUosRUFBaEI7QUFDQSxVQUFNVSxjQUFZLElBQUlaLE1BQUosRUFBbEI7O0FBRUEsVUFBTWEsT0FBT0MsT0FBT0MsY0FBUCxDQUFzQk4sUUFBdEIsRUFBZ0MsS0FBS08sU0FBckMsQ0FBYjtBQUNBRixXQUFPRyxnQkFBUCxDQUEwQkosSUFBMUIsRUFDRSxFQUFJSyxlQUFlLEVBQUlDLE9BQU9SLFVBQVVTLEdBQVYsQ0FBY0MsSUFBZCxDQUFtQlYsU0FBbkIsQ0FBWCxFQUFuQixFQUNJVyxpQkFBaUIsRUFBSUgsT0FBT1AsWUFBWVEsR0FBWixDQUFnQkMsSUFBaEIsQ0FBcUJULFdBQXJCLENBQVgsRUFEckIsRUFFSVcsYUFBYSxFQUFJSixPQUFP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eUI7QUFDdkIsaUJBQU9BLEtBQVA7QUFBWTtBQUFBO0FBQUEsS0FibEI7QUFha0I7QUF2UWdCOztBQTBRdEMsTUFBTXNELGVBQU4sU0FBOEIzRSxLQUE5QixDQUFvQzs7QUFFcEMsTUFBTW1HLGlCQUFpQnRHLGVBQWVJLE1BQWYsQ0FBc0JjLElBQXRCLENBQTJCbEIsY0FBM0IsQ0FBdkI7O0FBRUF1RyxPQUFPQyxPQUFQLEdBQWlCQSxVQUFVRixnQkFBM0I7QUFDQTNGLE9BQU91QixNQUFQLENBQWdCc0UsT0FBaEIsRUFDSSxFQUFJeEcsY0FBSixFQUFvQjhFLGVBQXBCO0FBQ0l3QixnQkFESixFQUNvQmxHLFFBQVFrRyxjQUQ1QixFQURKIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgcm9vdF9vYmogPSB7fSwgcm9vdF9saXN0ID0gW11cbmNvbnN0IE9iak1hcCA9ICd1bmRlZmluZWQnICE9PSB0eXBlb2YgV2Vha01hcCA/IFdlYWtNYXAgOiBNYXBcblxuY2xhc3MgUmV2aXRhbGl6YXRpb24gZXh0ZW5kcyBGdW5jdGlvbiA6OlxuICBjb25zdHJ1Y3RvcigpIDo6XG4gICAgdGhyb3cgbmV3IEVycm9yKCdVc2UgdGhlIHN0YXRpYyAuY3JlYXRlKCkgaW5zdGVhZCBvZiBuZXcnKVxuXG4gIHN0YXRpYyBjcmVhdGUodG9rZW5fcCkgOjpcbiAgICByZWdpc3Rlci50b2tlbiA9IHRva2VuX3AgfHwgJ1xcdTAzOUUnIC8vICfOnidcblxuICAgIGNvbnN0IGx1dFJldml2ZT1uZXcgTWFwKClcbiAgICBjb25zdCBsdXRQcmVzZXJ2ZT1uZXcgT2JqTWFwKClcblxuICAgIGNvbnN0IHNlbGYgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YocmVnaXN0ZXIsIHRoaXMucHJvdG90eXBlKVxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzIEAgc2VsZixcbiAgICAgIEB7fSBsb29rdXBSZXZpdmVyOiBAe30gdmFsdWU6IGx1dFJldml2ZS5nZXQuYmluZChsdXRSZXZpdmUpXG4gICAgICAgICwgbG9va3VwUHJlc2VydmVyOiBAe30gdmFsdWU6IGx1dFByZXNlcnZlLmdldC5iaW5kKGx1dFByZXNlcnZlKVxuICAgICAgICAsIF9zZXRSZXZpdmVyOiBAe30gdmFsdWU6IF9zZXRSZXZpdmVyXG5cblxuICAgIHNlbGYuaW5pdFJlZ2lzdGVyeShyb290X29iaiwgcm9vdF9saXN0KVxuICAgIHJldHVybiBzZWxmXG5cbiAgICBmdW5jdGlvbiByZWdpc3RlcigpIDo6XG4gICAgICByZXR1cm4gc2VsZi5yZWdpc3Rlci5hcHBseShzZWxmLCBhcmd1bWVudHMpXG5cbiAgICBmdW5jdGlvbiBfc2V0UmV2aXZlcihlbnRyeSwga2luZHMsIG1hdGNoZXJzKSA6OlxuICAgICAgbHV0UmV2aXZlLnNldChlbnRyeS5raW5kLCBlbnRyeSlcbiAgICAgIHJldHVybiA6OlxuICAgICAgICAgIGFsaWFzKC4uLmtpbmRzKSA6OlxuICAgICAgICAgICAgZm9yIGNvbnN0IGVhY2ggb2Yga2luZHMgOjpcbiAgICAgICAgICAgICAgaWYgZWFjaCA6OiBsdXRSZXZpdmUuc2V0KGVhY2gsIGVudHJ5KVxuICAgICAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgLCBtYXRjaCguLi5tYXRjaGVycykgOjpcbiAgICAgICAgICAgIGZvciBjb25zdCBlYWNoIG9mIG1hdGNoZXJzIDo6XG4gICAgICAgICAgICAgIGlmIG51bGwgIT0gZWFjaCA6OiBsdXRQcmVzZXJ2ZS5zZXQoZWFjaCwgZW50cnkpXG4gICAgICAgICAgICByZXR1cm4gdGhpc1xuXG5cbiAgaW5pdFJlZ2lzdGVyeShyb290X29iaiwgcm9vdF9saXN0KSA6OlxuICAgIHRoaXNcbiAgICAgIC5yZWdpc3RlciBAOiBraW5kOiAne3Jvb3R9J1xuICAgICAgICAsIHJldml2ZShvYmosIGVudHJ5KSA6OiBPYmplY3QuYXNzaWduKG9iaiwgZW50cnkuYm9keSlcbiAgICAgIC5tYXRjaCBAIHJvb3Rfb2JqXG5cbiAgICB0aGlzXG4gICAgICAucmVnaXN0ZXIgQDoga2luZDogJ1tyb290XSdcbiAgICAgICAgLCBwcmVzZXJ2ZShyb290TGlzdCkgOjogcmV0dXJuIEB7fSBfOiByb290TGlzdC5zbGljZSgpXG4gICAgICAgICwgaW5pdChlbnRyeSkgOjogcmV0dXJuIFtdXG4gICAgICAgICwgcmV2aXZlKHJvb3RMaXN0LCBlbnRyeSkgOjpcbiAgICAgICAgICAgIHJvb3RMaXN0LnB1c2guYXBwbHkocm9vdExpc3QsIGVudHJ5LmJvZHkuXylcbiAgICAgIC5tYXRjaCBAIHJvb3RfbGlzdFxuXG4gIHJlZ2lzdGVyKHJldml0YWxpemVyKSA6OlxuICAgIGlmICdraW5kJyBpbiByZXZpdGFsaXplciAmJiByZXZpdGFsaXplci5yZXZpdmUgOjpcbiAgICAgIHJldHVybiB0aGlzLnJlZ2lzdGVyUmV2aXZlcihyZXZpdGFsaXplcilcblxuICAgIGxldCB0Z3RcbiAgICBpZiB1bmRlZmluZWQgIT09IHJldml0YWxpemVyLnByb3RvdHlwZSA6OlxuICAgICAgdGd0ID0gcmV2aXRhbGl6ZXIucHJvdG90eXBlW3RoaXMudG9rZW5dXG4gICAgICBpZiB1bmRlZmluZWQgIT09IHRndCA6OlxuICAgICAgICBpZiAnZnVuY3Rpb24nID09PSB0eXBlb2YgdGd0IDo6XG4gICAgICAgICAgdGd0ID0gdGd0LmNhbGwocmV2aXRhbGl6ZXIucHJvdG90eXBlLCB0aGlzKVxuICAgICAgICAgIGlmIG51bGwgPT0gdGd0IDo6IHJldHVyblxuICAgICAgICBpZiAnc3RyaW5nJyA9PT0gdHlwZW9mIHRndCA6OlxuICAgICAgICAgIHJldHVybiB0aGlzLnJlZ2lzdGVyQ2xhc3ModGd0LCByZXZpdGFsaXplcilcblxuICAgIHRndCA9IHJldml0YWxpemVyW3RoaXMudG9rZW5dXG4gICAgaWYgdW5kZWZpbmVkICE9PSB0Z3QgOjpcbiAgICAgIGlmICdmdW5jdGlvbicgPT09IHR5cGVvZiB0Z3QgOjpcbiAgICAgICAgdGd0ID0gdGd0LmNhbGwocmV2aXRhbGl6ZXIsIHRoaXMpXG4gICAgICAgIGlmIG51bGwgPT0gdGd0IDo6IHJldHVyblxuICAgICAgaWYgJ3N0cmluZycgPT09IHR5cGVvZiB0Z3QgOjpcbiAgICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJQcm90byh0Z3QsIHJldml0YWxpemVyLnByb3RvdHlwZSB8fCByZXZpdGFsaXplcilcbiAgICAgICAgICAubWF0Y2gocmV2aXRhbGl6ZXIpXG5cbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBVbnJlY29nbml6ZWQgcmV2aXRhbGl6YXRpb24gcmVnaXN0cmF0aW9uYClcblxuICByZWdpc3RlclJldml2ZXIoZW50cnkpIDo6XG4gICAgOjpcbiAgICAgIGNvbnN0IGtpbmQgPSBlbnRyeS5raW5kXG4gICAgICBpZiAnc3RyaW5nJyAhPT0gdHlwZW9mIGtpbmQgJiYgdHJ1ZSAhPT0ga2luZCAmJiBmYWxzZSAhPT0ga2luZCAmJiBudWxsICE9PSBraW5kIDo6XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IgQCBgXCJraW5kXCIgbXVzdCBiZSBhIHN0cmluZ2BcblxuICAgICAgaWYgZW50cnkuaW5pdCAmJiAnZnVuY3Rpb24nICE9PSB0eXBlb2YgZW50cnkuaW5pdCA6OlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yIEAgJ1wiaW5pdFwiIG11c3QgYmUgYSBmdW5jdGlvbidcblxuICAgICAgaWYgJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIGVudHJ5LnJldml2ZSA6OlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yIEAgJ1wicmV2aXZlXCIgbXVzdCBiZSBhIGZ1bmN0aW9uJ1xuXG4gICAgICBpZiBlbnRyeS5wcmVzZXJ2ZSAmJiAnZnVuY3Rpb24nICE9PSB0eXBlb2YgZW50cnkucHJlc2VydmUgOjpcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvciBAICdcInByZXNlcnZlXCIgbXVzdCBiZSBhIGZ1bmN0aW9uIGlmIHByb3ZpZGVkJ1xuXG4gICAgcmV0dXJuIHRoaXMuX3NldFJldml2ZXIoZW50cnkpXG5cbiAgcmVnaXN0ZXJDbGFzcyhraW5kLCBrbGFzcykgOjpcbiAgICByZXR1cm4gdGhpc1xuICAgICAgLnJlZ2lzdGVyUmV2aXZlciBAOiBraW5kLFxuICAgICAgICByZXZpdmUob2JqLCBlbnRyeSkgOjpcbiAgICAgICAgICBvYmogPSBPYmplY3QuYXNzaWduKG9iaiwgZW50cnkuYm9keSlcbiAgICAgICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2Yob2JqLCBrbGFzcy5wcm90b3R5cGUpXG4gICAgICAubWF0Y2goa2xhc3MsIGtsYXNzLnByb3RvdHlwZSlcblxuICByZWdpc3RlclByb3RvKGtpbmQsIHByb3RvKSA6OlxuICAgIHJldHVybiB0aGlzXG4gICAgICAucmVnaXN0ZXJSZXZpdmVyIEA6IGtpbmQsXG4gICAgICAgIHJldml2ZShvYmosIGVudHJ5KSA6OlxuICAgICAgICAgIG9iaiA9IE9iamVjdC5hc3NpZ24ob2JqLCBlbnRyeS5ib2R5KVxuICAgICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihvYmosIHByb3RvKVxuICAgICAgLm1hdGNoKHByb3RvKVxuXG5cbiAgZGVjb2RlKGFTdHJpbmcsIGN0eCkgOjpcbiAgICBpZiBudWxsID09IGN0eCA6OiBjdHggPSB7fVxuICAgIGNvbnN0IHRva2VuPXRoaXMudG9rZW4sIGxvb2t1cFJldml2ZXI9dGhpcy5sb29rdXBSZXZpdmVyXG5cbiAgICBjb25zdCBxdWV1ZT1bXSwgYnlPaWQ9bmV3IE1hcCgpXG4gICAgSlNPTi5wYXJzZShhU3RyaW5nLCBfanNvbl9jcmVhdGUpXG5cbiAgICBjb25zdCByZWZzPW5ldyBPYmpNYXAoKVxuICAgIEpTT04ucGFyc2UoYVN0cmluZywgX2pzb25fcmVzdG9yZSlcblxuICAgIGNvbnN0IGRvbmUgPSBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgLnRoZW4gQCAoKSA9PlxuICAgICAgICBQcm9taXNlLmFsbCBAIHF1ZXVlLnJldmVyc2UoKS5tYXAgQCBlbnRyeSA9PiA6OlxuICAgICAgICAgIGVudHJ5LmRvbmUgPSBkb25lXG4gICAgICAgICAgbGV0IGFucyA9IGVudHJ5LnJldml2ZXIucmV2aXZlKGVudHJ5Lm9iaiwgZW50cnksIGN0eClcbiAgICAgICAgICBpZiAwID09PSBlbnRyeS5vaWQgOjpcbiAgICAgICAgICAgIGNvbnNvbGUubG9nIEAgJ2hlcmUnXG4gICAgICAgICAgICBlbnRyeS5wcm9taXNlID0gYW5zID0gUHJvbWlzZS5yZXNvbHZlKGFucylcbiAgICAgICAgICByZXR1cm4gYW5zXG5cbiAgICByZXR1cm4gZG9uZS50aGVuIEAgKCkgPT4gOjpcbiAgICAgIGNvbnN0IHtvYmosIHByb21pc2V9ID0gYnlPaWQuZ2V0KDApXG4gICAgICByZXR1cm4gdW5kZWZpbmVkID09PSBwcm9taXNlID8gb2JqXG4gICAgICAgIDogcHJvbWlzZS50aGVuIEAgYW5zID0+XG4gICAgICAgICAgICBhbnMgIT09IHVuZGVmaW5lZCA/IGFucyA6IG9ialxuXG5cbiAgICBmdW5jdGlvbiBfanNvbl9jcmVhdGUoa2V5LCB2YWx1ZSkgOjpcbiAgICAgIGlmIHRva2VuID09PSBrZXkgOjpcbiAgICAgICAgaWYgJ251bWJlcicgPT09IHR5cGVvZiB2YWx1ZSA6OlxuICAgICAgICBlbHNlIGlmIEFycmF5LmlzQXJyYXkodmFsdWUpIDo6XG4gICAgICAgICAgZGVsZXRlIHRoaXNbdG9rZW5dXG5cbiAgICAgICAgICBjb25zdCBba2luZCwgb2lkXSA9IHZhbHVlXG4gICAgICAgICAgY29uc3QgcmV2aXZlciA9IGxvb2t1cFJldml2ZXIoa2luZClcbiAgICAgICAgICBpZiB1bmRlZmluZWQgPT09IHJldml2ZXIgOjpcbiAgICAgICAgICAgIHRocm93IG5ldyBSZXZpdmVyTm90Rm91bmQoYE1pc3NpbmcgcmVnaXN0ZXJlZCByZXZpdmVyIGZvciBraW5kIFwiJHtraW5kfVwiYClcblxuICAgICAgICAgIGNvbnN0IGVudHJ5ID0gQDoga2luZCwgb2lkLCByZXZpdmVyLCBib2R5OiB0aGlzXG5cbiAgICAgICAgICBlbnRyeS5vYmogPSByZXZpdmVyLmluaXRcbiAgICAgICAgICAgID8gcmV2aXZlci5pbml0KGVudHJ5LCBjdHgpXG4gICAgICAgICAgICA6IE9iamVjdC5jcmVhdGUobnVsbClcblxuICAgICAgICAgIGJ5T2lkLnNldChvaWQsIGVudHJ5KVxuICAgICAgICAgIHF1ZXVlLnB1c2goZW50cnkpXG4gICAgICAgIHJldHVyblxuXG4gICAgICByZXR1cm4gdmFsdWVcblxuXG4gICAgZnVuY3Rpb24gX2pzb25fcmVzdG9yZShrZXksIHZhbHVlKSA6OlxuICAgICAgaWYgdG9rZW4gPT09IGtleSA6OlxuICAgICAgICBpZiAnbnVtYmVyJyA9PT0gdHlwZW9mIHZhbHVlIDo6XG4gICAgICAgICAgcmVmcy5zZXQgQCB0aGlzLCBieU9pZC5nZXQodmFsdWUpLm9ialxuXG4gICAgICAgIGVsc2UgaWYgQXJyYXkuaXNBcnJheSh2YWx1ZSkgOjpcbiAgICAgICAgICBjb25zdCBlbnRyeSA9IGJ5T2lkLmdldCh2YWx1ZVsxXSlcbiAgICAgICAgICBlbnRyeS5ib2R5ID0gdGhpc1xuICAgICAgICAgIHJlZnMuc2V0IEAgdGhpcywgZW50cnkub2JqXG4gICAgICAgIHJldHVyblxuXG4gICAgICBlbHNlIGlmIG51bGwgPT09IHZhbHVlIHx8ICdvYmplY3QnICE9PSB0eXBlb2YgdmFsdWUgOjpcbiAgICAgICAgcmV0dXJuIHZhbHVlXG5cbiAgICAgIGNvbnN0IGFucyA9IHJlZnMuZ2V0KHZhbHVlKVxuICAgICAgcmV0dXJuIGFucyAhPT0gdW5kZWZpbmVkID8gYW5zIDogdmFsdWVcblxuXG4gIGVuY29kZShhbk9iamVjdCwgY3R4KSA6OlxuICAgIGNvbnN0IHJlZnMgPSBbXVxuICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmVuY29kZU9iamVjdHMgQCBhbk9iamVjdCwgY3R4LCAoZXJyLCBlbnRyeSkgPT4gOjpcbiAgICAgIHJlZnNbZW50cnkub2lkXSA9IGVudHJ5LmNvbnRlbnRcblxuICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5IEAgYCR7dGhpcy50b2tlbn1yZWZzYFxuICAgIHJldHVybiBwcm9taXNlLnRoZW4gQCAoKSA9PlxuICAgICAgYHske2tleX06IFtcXG4gICR7cmVmcy5qb2luKCcsXFxuICAnKX0gXX1cXG5gXG5cblxuICBlbmNvZGVPYmplY3RzKGFuT2JqZWN0LCBjdHgsIGNhbGxiYWNrKSA6OlxuICAgIGlmICdmdW5jdGlvbicgPT09IHR5cGVvZiBjdHggOjpcbiAgICAgIGNhbGxiYWNrID0gY3R4OyBjdHggPSB7fVxuICAgIGVsc2UgaWYgbnVsbCA9PSBjdHggOjpcbiAgICAgIGN0eCA9IHt9XG5cbiAgICBjb25zdCB0b2tlbj10aGlzLnRva2VuLCBsb29rdXBQcmVzZXJ2ZXI9dGhpcy5sb29rdXBQcmVzZXJ2ZXIsIGZpbmRQcmVzZXJ2ZXI9dGhpcy5fYm91bmRGaW5kUHJlc2VydmVGb3JPYmooKVxuXG4gICAgY29uc3QgcXVldWU9W10sIGxvb2t1cD1uZXcgTWFwKClcbiAgICBKU09OLnN0cmluZ2lmeShhbk9iamVjdCwgX2pzb25fcmVwbGFjZXIpXG5cbiAgICByZXR1cm4gX2VuY29kZVF1ZXVlKClcblxuICAgIGZ1bmN0aW9uIF9lbmNvZGVRdWV1ZSgpIDo6XG4gICAgICBpZiAwID09PSBxdWV1ZS5sZW5ndGggOjogcmV0dXJuXG5cbiAgICAgIGNvbnN0IHByb21pc2VzID0gW11cbiAgICAgIHdoaWxlIDAgIT09IHF1ZXVlLmxlbmd0aCA6OlxuICAgICAgICBjb25zdCB0aXAgPSBxdWV1ZS5zaGlmdCgpLCBvaWQgPSB0aXAub2lkXG4gICAgICAgIHByb21pc2VzLnB1c2ggQFxuICAgICAgICAgIHRpcFxuICAgICAgICAgICAgLnRoZW4gQCBib2R5ID0+IDo6XG4gICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShib2R5LCBfanNvbl9yZXBsYWNlcilcbiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrIEAgbnVsbCwgeyBvaWQsIGJvZHksIGNvbnRlbnQgfVxuICAgICAgICAgICAgLmNhdGNoIEAgZXJyID0+IGNhbGxiYWNrKGVycilcblxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKF9lbmNvZGVRdWV1ZSlcblxuICAgIGZ1bmN0aW9uIF9qc29uX3JlcGxhY2VyKGtleSwgdmFsdWUpIDo6XG4gICAgICBpZiB2YWx1ZSA9PT0gbnVsbCB8fCAnb2JqZWN0JyAhPT0gdHlwZW9mIHZhbHVlIDo6XG4gICAgICAgIHJldHVybiB2YWx1ZVxuXG4gICAgICBjb25zdCBwcmV2ID0gbG9va3VwLmdldCh2YWx1ZSlcbiAgICAgIGlmIHVuZGVmaW5lZCAhPT0gcHJldiA6OlxuICAgICAgICByZXR1cm4gcHJldiAvLyBhbHJlYWR5IHNlcmlhbGl6ZWQgLS0gcmVmZXJlbmNlIGV4aXN0aW5nIGl0ZW1cblxuICAgICAgbGV0IGVudHJ5ID0gZmluZFByZXNlcnZlcih2YWx1ZSlcbiAgICAgIGlmIHVuZGVmaW5lZCA9PT0gZW50cnkgOjpcbiAgICAgICAgLy8gbm90IGEgXCJzcGVjaWFsXCIgcHJlc2VydmVkIGl0ZW1cbiAgICAgICAgaWYgYW5PYmplY3QgIT09IHZhbHVlIDo6XG4gICAgICAgICAgcmV0dXJuIHZhbHVlIC8vIHNvIHNlcmlhbGl6ZSBub3JtYWxseVxuICAgICAgICAvLyBidXQgaXQgaXMgdGhlIHJvb3QsIHNvIHN0b3JlIGF0IG9pZCAwXG4gICAgICAgIGVudHJ5ID0gbG9va3VwUHJlc2VydmVyIEBcbiAgICAgICAgICBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHJvb3RfbGlzdCA6IHJvb3Rfb2JqXG5cbiAgICAgIC8vIHJlZ2lzdGVyIGlkIGZvciBvYmplY3QgYW5kIHJldHVybiBhIEpTT04gc2VyaWFsaXphYmxlIHZlcnNpb25cbiAgICAgIGNvbnN0IG9pZCA9IGxvb2t1cC5zaXplXG4gICAgICBjb25zdCByZWYgPSB7W3Rva2VuXTogb2lkfVxuICAgICAgbG9va3VwLnNldCh2YWx1ZSwgcmVmKVxuXG4gICAgICAvLyB0cmFuc2Zvcm0gbGl2ZSBvYmplY3QgaW50byBwcmVzZXJ2ZWQgZm9ybVxuICAgICAgY29uc3QgYm9keSA9IHtbdG9rZW5dOiBbZW50cnkua2luZCwgb2lkXX1cbiAgICAgIGNvbnN0IHByb21pc2UgPSBQcm9taXNlXG4gICAgICAgIC5yZXNvbHZlIEAgZW50cnkucHJlc2VydmUgPyBlbnRyeS5wcmVzZXJ2ZSh2YWx1ZSwgY3R4KSA6IHZhbHVlXG4gICAgICAgIC50aGVuIEAgYXR0cnMgPT4gT2JqZWN0LmFzc2lnbihib2R5LCBhdHRycylcblxuICAgICAgcHJvbWlzZS5vaWQgPSBvaWRcbiAgICAgIHF1ZXVlLnB1c2ggQCBwcm9taXNlXG4gICAgICByZXR1cm4gcmVmXG5cbiAgX2JvdW5kRmluZFByZXNlcnZlRm9yT2JqKCkgOjpcbiAgICBjb25zdCBsb29rdXBQcmVzZXJ2ZXIgPSB0aGlzLmxvb2t1cFByZXNlcnZlclxuICAgIHJldHVybiBmdW5jdGlvbihvYmopIDo6XG4gICAgICBsZXQgZW50cnkgPSBsb29rdXBQcmVzZXJ2ZXIob2JqKVxuICAgICAgaWYgdW5kZWZpbmVkICE9PSBlbnRyeSA6OlxuICAgICAgICByZXR1cm4gZW50cnlcblxuICAgICAgZW50cnkgPSBsb29rdXBQcmVzZXJ2ZXIob2JqLmNvbnN0cnVjdG9yKVxuICAgICAgaWYgdW5kZWZpbmVkICE9PSBlbnRyeSA6OlxuICAgICAgICByZXR1cm4gZW50cnlcblxuICAgICAgbGV0IHByb3RvID0gb2JqXG4gICAgICB3aGlsZSBudWxsICE9PSBAIHByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvKSA6OlxuICAgICAgICBsZXQgZW50cnkgPSBsb29rdXBQcmVzZXJ2ZXIocHJvdG8pXG4gICAgICAgIGlmIHVuZGVmaW5lZCAhPT0gZW50cnkgOjpcbiAgICAgICAgICByZXR1cm4gZW50cnlcblxuXG5jbGFzcyBSZXZpdmVyTm90Rm91bmQgZXh0ZW5kcyBFcnJvciA6OlxuXG5jb25zdCBjcmVhdGVSZWdpc3RyeSA9IFJldml0YWxpemF0aW9uLmNyZWF0ZS5iaW5kKFJldml0YWxpemF0aW9uKVxuXG5tb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjcmVhdGVSZWdpc3RyeSgpXG5PYmplY3QuYXNzaWduIEAgZXhwb3J0c1xuICAsIEB7fSBSZXZpdGFsaXphdGlvbiwgUmV2aXZlck5vdEZvdW5kXG4gICAgICAsIGNyZWF0ZVJlZ2lzdHJ5LCBjcmVhdGU6IGNyZWF0ZVJlZ2lzdHJ5XG4iXX0=