define(["exports"],function(e){"use strict";function t(e,t,r){if(null===t)return null;const i=e.token,o=e.lookupReviver,s=[],u=new Map,c=[];c[0]=JSON.parse(t,function(e,t){if(i!==e)return t;if("number"==typeof t);else if(Array.isArray(t)){delete this[i];const[e,n]=t,c=o(e);if(void 0===c)throw new ReviverNotFound(`Missing registered reviver for kind "${e}"`);const f={kind:e,oid:n,reviver:c,body:this};f.obj=c.init?c.init(f,r):Object.create(null),u.set(n,f),s.push(f)}});const f=new n;c[1]=JSON.parse(t,function(e,t){if(i===e){if("number"==typeof t)f.set(this,u.get(t).obj);else if(Array.isArray(t)){const e=u.get(t[1]);e.body=this,f.set(this,e.obj)}return}if(null===t||"object"!=typeof t)return t;const r=f.get(t);return void 0!==r?r:t});const v={},l=Promise.resolve().then(()=>s.reverse().map(e=>(e.evts=v,e.reviver.revive(e.obj,e,r))));return v.started=l.then(e=>e.length),v.finished=l.then(e=>Promise.all(e).then(e=>e.length)),v.done=v.finished.then(()=>{const e=u.get(0);if(null==e)return;const{obj:t,promise:r}=e;return void 0===r?t:r.then(e=>void 0!==e?e:t)}),v}function r(e,t,r,n){function s(){if(0===l.length)return Promise.resolve();const e=[];for(;0!==l.length;){const t=l.shift(),r=t.oid;e.push(t.then(e=>{try{var t=JSON.stringify(e,u)}catch(e){return n(e)}return n(null,{oid:r,body:e,content:t})},e=>n(e)))}return Promise.all(e).then(s)}function u(e,n){const s=this[e];if(null===n||"object"!=typeof s)return n;const u=d.get(s);if(void 0!==u)return u;let p=v(s);if(void 0===p){if(t!==s)return n;p=f(Array.isArray(n)?o:i)}const a=d.size,h={[c]:a};d.set(s,h);const y={[c]:[p.kind,a]},b=Promise.resolve(p.preserve?p.preserve(n,s,r):n).then(e=>Object.assign(y,e));return b.oid=a,l.push(b),h}const c=e.token,f=e.lookupPreserver,v=e._boundFindPreserveForObj(),l=[],d=new Map;return[][0]=JSON.stringify(t,u),s()}const n="undefined"!=typeof WeakMap?WeakMap:Map,i=Object.freeze({}),o=Object.freeze([]);class s extends Function{constructor(){throw new Error("Use the static .create() instead of new")}static create(e){function t(){return u.register.apply(u,arguments)}t.token=e||"Îž";const r=new Map,s=new n,u=Object.setPrototypeOf(t,this.prototype);return Object.defineProperties(u,{lookupReviver:{value:r.get.bind(r)},lookupPreserver:{value:s.get.bind(s)},_setReviver:{value:function(e,t,n){return r.set(e.kind,e),{alias(...t){for(const n of t)n&&r.set(n,e);return this},match(...t){for(const r of t)null!=r&&s.set(r,e);return this}}}}}),u.initRegistery(i,o),u}initRegistery(e,t){this.register({kind:"{root}",revive(e,t){Object.assign(e,t.body)}}).match(e),this.register({kind:"[root]",preserve:e=>({_:e.slice()}),init:e=>[],revive(e,t){e.push.apply(e,t.body._)}}).match(t)}register(e){if("kind"in e&&e.revive)return this.registerReviver(e);let t;if(void 0!==e.prototype&&void 0!==(t=e.prototype[this.token])){if("function"==typeof t&&null==(t=t.call(e.prototype,this)))return;if("string"==typeof t)return this.registerClass(t,e)}if(void 0!==(t=e[this.token])){if("function"==typeof t&&null==(t=t.call(e,this)))return;if("string"==typeof t)return this.registerProto(t,e.prototype||e).match(e)}throw new TypeError("Unrecognized revitalization registration")}registerReviver(e){{const t=e.kind;if("string"!=typeof t&&!0!==t&&!1!==t&&null!==t)throw new TypeError('"kind" must be a string');if(e.init&&"function"!=typeof e.init)throw new TypeError('"init" must be a function');if("function"!=typeof e.revive)throw new TypeError('"revive" must be a function');if(e.preserve&&"function"!=typeof e.preserve)throw new TypeError('"preserve" must be a function if provided')}return this._setReviver(e)}registerClass(e,t){return this.registerReviver({kind:e,revive(e,r){e=Object.assign(e,r.body),Object.setPrototypeOf(e,t.prototype)}}).match(t,t.prototype)}registerProto(e,t){return this.registerReviver({kind:e,revive(e,r){e=Object.assign(e,r.body),Object.setPrototypeOf(e,t)}}).match(t)}decode(e,r){if(null===e)return null;return t(this,e,r).done}encodeToRefs(e,t,n){null==n&&(n=[]);return r(this,e,t,(e,t)=>{n[t.oid]=t.content}).then(()=>n)}encode(e,t,r){return this.encodeToRefs(e,t).then(e=>{const t=JSON.stringify(`${this.token}refs`);return r?`{${t}: [\n  ${e.join(",\n  ")} ]}\n`:`{${t}:[${e.join(",")}]}`})}_boundFindPreserveForObj(){const e=this.lookupPreserver;return function(t){let r=e(t);if(void 0!==r)return r;if(void 0!==(r=e(t.constructor)))return r;let n=t;for(;null!==(n=Object.getPrototypeOf(n));){let t=e(n);if(void 0!==t)return t}}}}const u=s.create.bind(s);var c=u();e.default=c,e.createRegistry=u,e.create=u,e.root_obj=i,e.root_list=o,e.encodeObjectTree=r,e.ObjMap=n,e.decodeObjectTree=t,e.Revitalization=s,e.ReviverNotFound=class extends Error{},Object.defineProperty(e,"__esModule",{value:!0})});
