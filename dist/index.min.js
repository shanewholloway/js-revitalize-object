define(["exports"],function(e){"use strict";function t(e,t,r){if(null===t)return null;const n=e.token,o=e.lookupReviver,s=[],c=new Map,u=[];u[0]=JSON.parse(t,function(e,t){if(n!==e)return t;if("number"==typeof t);else if(Array.isArray(t)){delete this[n];const[e,i]=t,u=o(e);if(void 0===u)throw new ReviverNotFound(`Missing registered reviver for kind "${e}"`);const f={kind:e,oid:i,reviver:u,body:this};f.obj=u.init?u.init(f,r):Object.create(null),c.set(i,f),s.push(f)}});const f=new i;u[1]=JSON.parse(t,function(e,t){if(n===e){if("number"==typeof t)f.set(this,c.get(t).obj);else if(Array.isArray(t)){const e=c.get(t[1]);e.body=this,f.set(this,e.obj)}return}if(null===t||"object"!=typeof t)return t;const r=f.get(t);return void 0!==r?r:t});const v={},d=Promise.resolve().then(()=>s.reverse().map(e=>(e.evts=v,e.reviver.revive(e.obj,e,r))));return v.started=d.then(e=>e.length),v.finished=d.then(e=>Promise.all(e).then(e=>e.length)),v.done=v.finished.then(()=>{const e=c.get(0);if(null==e)return;const{obj:t,promise:r}=e;return void 0===r?t:r.then(e=>void 0!==e?e:t)}),v}function r(e,t,r,i){function s(e,r){const i=this[e];if(null===r||"object"!=typeof i)return r;const s=d.get(i);if(void 0!==s)return s;let l=f(i);if(void 0===l){if(t!==i)return r;l=u(Array.isArray(r)?o:n)}const p=d.size,a={[c]:p};d.set(i,a);const h=e=>{const t={[c]:[l.kind,p]};if(l.preserve){const n=l.preserve(r,i,e);return Object.assign(t,n)}return Object.assign(t,r)};return h.oid=p,v.push(h),a}const c=e.token,u=e.lookupPreserver,f=e._boundFindPreserveForObj(),v=[],d=new Map;for([][0]=JSON.stringify(t,s);0!==v.length;){const e=v.shift(),{oid:t}=e;let n,o;try{n=e(r),o=JSON.stringify(n,s)}catch(e){i(e,{oid:t,body:n});continue}i(null,{oid:t,body:n,content:o})}}const i="undefined"!=typeof WeakMap?WeakMap:Map,n=Object.freeze({}),o=Object.freeze([]);class s extends Function{constructor(){throw new Error("Use the static .create() instead of new")}static create(e){function t(){return c.register.apply(c,arguments)}t.token=e||"Îž";const r=new Map,s=new i,c=Object.setPrototypeOf(t,this.prototype);return Object.defineProperties(c,{lookupReviver:{value:r.get.bind(r)},lookupPreserver:{value:s.get.bind(s)},_setReviver:{value:function(e,t,i){return r.set(e.kind,e),{alias(...t){for(const i of t)i&&r.set(i,e);return this},match(...t){for(const r of t)null!=r&&s.set(r,e);return this}}}}}),c.initRegistery(n,o),c}initRegistery(e,t){this.register({kind:"{root}",revive(e,t){Object.assign(e,t.body)}}).match(e),this.register({kind:"[root]",preserve:e=>({_:e.slice()}),init:e=>[],revive(e,t){e.push.apply(e,t.body._)}}).match(t)}register(e){if("kind"in e&&e.revive)return this.registerReviver(e);let t;if(void 0!==e.prototype&&void 0!==(t=e.prototype[this.token])){if("function"==typeof t&&null==(t=t.call(e.prototype,this)))return;if("string"==typeof t)return this.registerClass(t,e)}if(void 0!==(t=e[this.token])){if("function"==typeof t&&null==(t=t.call(e,this)))return;if("string"==typeof t)return this.registerProto(t,e.prototype||e).match(e)}throw new TypeError("Unrecognized revitalization registration")}registerReviver(e){{const t=e.kind;if("string"!=typeof t&&!0!==t&&!1!==t&&null!==t)throw new TypeError('"kind" must be a string');if(e.init&&"function"!=typeof e.init)throw new TypeError('"init" must be a function');if("function"!=typeof e.revive)throw new TypeError('"revive" must be a function');if(e.preserve&&"function"!=typeof e.preserve)throw new TypeError('"preserve" must be a function if provided')}return this._setReviver(e)}registerClass(e,t){return this.registerReviver({kind:e,revive(e,r){e=Object.assign(e,r.body),Object.setPrototypeOf(e,t.prototype)}}).match(t,t.prototype)}registerProto(e,t){return this.registerReviver({kind:e,revive(e,r){e=Object.assign(e,r.body),Object.setPrototypeOf(e,t)}}).match(t)}decode(e,r){if(null===e)return null;return t(this,e,r).done}encodeToRefs(e,t,i){return null==i&&(i=[]),r(this,e,t,(e,t)=>{i[t.oid]=t.content}),i}encode(e,t,r){const i=this.encodeToRefs(e,t),n=JSON.stringify(`${this.token}refs`);return r?`{${n}: [\n  ${i.join(",\n  ")} ]}\n`:`{${n}:[${i.join(",")}]}`}_boundFindPreserveForObj(){const e=this.lookupPreserver;return function(t){let r=e(t);if(void 0!==r)return r;if(void 0!==(r=e(t.constructor)))return r;let i=t;for(;null!==(i=Object.getPrototypeOf(i));){let t=e(i);if(void 0!==t)return t}}}}const c=s.create.bind(s);var u=c();e.default=u,e.createRegistry=c,e.create=c,e.root_obj=n,e.root_list=o,e.encodeObjectTree=r,e.ObjMap=i,e.decodeObjectTree=t,e.Revitalization=s,e.ReviverNotFound=class extends Error{},Object.defineProperty(e,"__esModule",{value:!0})});
