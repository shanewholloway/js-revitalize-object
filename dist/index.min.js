define(["exports"],function(e){"use strict";const t="undefined"!=typeof WeakMap?WeakMap:Map,r=Object.freeze({}),n=Object.freeze([]);class i extends Function{constructor(){throw new Error("Use the static .create() instead of new")}static create(e){function i(){return u.register.apply(u,arguments)}i.token=e||"Îž";const o=new Map,s=new t,u=Object.setPrototypeOf(i,this.prototype);return Object.defineProperties(u,{lookupReviver:{value:o.get.bind(o)},lookupPreserver:{value:s.get.bind(s)},_setReviver:{value:function(e,t,r){return o.set(e.kind,e),{alias(...t){for(const r of t)r&&o.set(r,e);return this},match(...t){for(const r of t)null!=r&&s.set(r,e);return this}}}}}),u.initRegistery(r,n),u}initRegistery(e,t){this.register({kind:"{root}",revive(e,t){Object.assign(e,t.body)}}).match(e),this.register({kind:"[root]",preserve:e=>({_:e.slice()}),init:e=>[],revive(e,t){e.push.apply(e,t.body._)}}).match(t)}register(e){if("kind"in e&&e.revive)return this.registerReviver(e);let t;if(void 0!==e.prototype&&void 0!==(t=e.prototype[this.token])){if("function"==typeof t&&null==(t=t.call(e.prototype,this)))return;if("string"==typeof t)return this.registerClass(t,e)}if(void 0!==(t=e[this.token])){if("function"==typeof t&&null==(t=t.call(e,this)))return;if("string"==typeof t)return this.registerProto(t,e.prototype||e).match(e)}throw new TypeError("Unrecognized revitalization registration")}registerReviver(e){{const t=e.kind;if("string"!=typeof t&&!0!==t&&!1!==t&&null!==t)throw new TypeError('"kind" must be a string');if(e.init&&"function"!=typeof e.init)throw new TypeError('"init" must be a function');if("function"!=typeof e.revive)throw new TypeError('"revive" must be a function');if(e.preserve&&"function"!=typeof e.preserve)throw new TypeError('"preserve" must be a function if provided')}return this._setReviver(e)}registerClass(e,t){return this.registerReviver({kind:e,revive(e,r){e=Object.assign(e,r.body),Object.setPrototypeOf(e,t.prototype)}}).match(t,t.prototype)}registerProto(e,t){return this.registerReviver({kind:e,revive(e,r){e=Object.assign(e,r.body),Object.setPrototypeOf(e,t)}}).match(t)}decode(e,t){if(null===e)return null;return function(e,t,r){if(null===t)return null;e.token,e.lookupReviver;const n=[],i=new Map,o={},s=Promise.resolve().then(()=>n.reverse().map(e=>(e.evts=o,e.reviver.revive(e.obj,e,r))));return o.started=s.then(e=>e.length),o.finished=s.then(e=>Promise.all(e).then(e=>e.length)),o.done=o.finished.then(()=>{const e=i.get(0);if(null==e)return;const{obj:t,promise:r}=e;return void 0===r?t:r.then(e=>void 0!==e?e:t)}),o}(this,e,t).done}encode(e,t){const i=[],o=function(e,t,i,o){function s(){if(0===l.length)return Promise.resolve();const e=[];for(;0!==l.length;){const t=l.shift(),r=t.oid;e.push(t.then(e=>{try{var t=JSON.stringify(e,u)}catch(e){return o(e)}return o(null,{oid:r,body:e,content:t})},e=>o(e)))}return Promise.all(e).then(s)}function u(e,o){const s=this[e];if(null===o||"object"!=typeof s)return o;const u=p.get(s);if(void 0!==u)return u;let a=v(s);if(void 0===a){if(t!==s)return o;a=f(Array.isArray(o)?n:r)}const d=p.size,h={[c]:d};p.set(s,h);const y={[c]:[a.kind,d]},g=Promise.resolve(a.preserve?a.preserve(o,s,i):o).then(e=>Object.assign(y,e));return g.oid=d,l.push(g),h}const c=e.token,f=e.lookupPreserver,v=e._boundFindPreserveForObj(),l=[],p=new Map;return s()}(this,e,t,(e,t)=>{i[t.oid]=t.content}),s=JSON.stringify(`${this.token}refs`);return o.then(()=>`{${s}: [\n  ${i.join(",\n  ")} ]}\n`)}_boundFindPreserveForObj(){const e=this.lookupPreserver;return function(t){let r=e(t);if(void 0!==r)return r;if(void 0!==(r=e(t.constructor)))return r;let n=t;for(;null!==(n=Object.getPrototypeOf(n));){let t=e(n);if(void 0!==t)return t}}}}const o=i.create.bind(i);var s=o();e.default=s,e.createRegistry=o,e.create=o,e.Revitalization=i,e.ReviverNotFound=class extends Error{},Object.defineProperty(e,"__esModule",{value:!0})});
