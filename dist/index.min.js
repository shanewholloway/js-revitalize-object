'use strict';Object.defineProperty(exports,'__esModule',{value:!0}),exports.encodeObjectTree=encodeObjectTree;const root_obj=exports.root_obj={},root_list=exports.root_list=[];exports.default=encodeObjectTree;function encodeObjectTree(a,b,c,d){function e(){if(0===j.length)return Promise.resolve();const a=[];for(;0!==j.length;){const b=j.shift(),c=b.oid;a.push(b.then((a)=>{try{var b=JSON.stringify(a,f)}catch(a){return d(a)}return d(null,{oid:c,body:a,content:b})},(a)=>d(a)))}return Promise.all(a).then(e)}function f(a,d){const e=this[a];if(null===d||'object'!=typeof e)return d;const f=k.get(e);if(void 0!==f)return f;let l=i(e);if(void 0===l){if(b!==e)return d;l=h(Array.isArray(d)?root_list:root_obj)}const m=k.size,n={[g]:m};k.set(e,n);const o={[g]:[l.kind,m]},p=Promise.resolve(l.preserve?l.preserve(d,e,c):d).then((a)=>Object.assign(o,a));return p.oid=m,j.push(p),n}const g=a.token,h=a.lookupPreserver,i=a._boundFindPreserveForObj(),j=[],k=new Map;return JSON.stringify(b,f),e()}'use strict',Object.defineProperty(exports,'__esModule',{value:!0}),exports.decodeObjectTree=decodeObjectTree;const ObjMap=exports.ObjMap='undefined'==typeof WeakMap?Map:WeakMap;exports.default=decodeObjectTree;function decodeObjectTree(a,b,c){if(null===b)return null;const d=a.token,e=a.lookupReviver,f=[],g=new Map;JSON.parse(b,function(a,b){if(d===a){if('number'==typeof b);else if(Array.isArray(b)){delete this[d];const[a,h]=b,i=e(a);if(void 0===i)throw new ReviverNotFound(`Missing registered reviver for kind "${a}"`);const j={kind:a,oid:h,reviver:i,body:this};j.obj=i.init?i.init(j,c):Object.create(null),g.set(h,j),f.push(j)}return}return b});const h=new ObjMap;JSON.parse(b,function(a,b){if(d===a){if('number'==typeof b)h.set(this,g.get(b).obj);else if(Array.isArray(b)){const a=g.get(b[1]);a.body=this,h.set(this,a.obj)}return}if(null===b||'object'!=typeof b)return b;const c=h.get(b);return void 0===c?b:c});const i={},j=Promise.resolve().then(()=>f.reverse().map((a)=>{return a.evts=i,a.reviver.revive(a.obj,a,c)}));return i.started=j.then((a)=>a.length),i.finished=j.then((a)=>Promise.all(a).then((a)=>a.length)),i.done=i.finished.then(()=>{const a=g.get(0);if(null==a)return;const{obj:b,promise:c}=a;return void 0===c?b:c.then((a)=>void 0===a?b:a)}),i}class Revitalization extends Function{constructor(){throw new Error('Use the static .create() instead of new')}static create(a){function b(){return e.register.apply(e,arguments)}b.token=a||'\u039E';const c=new Map,d=new ObjMap,e=Object.setPrototypeOf(b,this.prototype);return Object.defineProperties(e,{lookupReviver:{value:c.get.bind(c)},lookupPreserver:{value:d.get.bind(d)},_setReviver:{value:function(a){return c.set(a.kind,a),{alias(...b){for(const d of b)d&&c.set(d,a);return this},match(...b){for(const c of b)null!=c&&d.set(c,a);return this}}}}}),e.initRegistery(root_obj,root_list),e}initRegistery(a,b){this.register({kind:'{root}',revive(a,b){Object.assign(a,b.body)}}).match(a),this.register({kind:'[root]',preserve(a){return{_:a.slice()}},init(){return[]},revive(a,b){a.push.apply(a,b.body._)}}).match(b)}register(a){if('kind'in a&&a.revive)return this.registerReviver(a);let b;if(void 0!==a.prototype&&(b=a.prototype[this.token],void 0!==b)){if('function'==typeof b&&(b=b.call(a.prototype,this),null==b))return;if('string'==typeof b)return this.registerClass(b,a)}if(b=a[this.token],void 0!==b){if('function'==typeof b&&(b=b.call(a,this),null==b))return;if('string'==typeof b)return this.registerProto(b,a.prototype||a).match(a)}throw new TypeError(`Unrecognized revitalization registration`)}registerReviver(a){{const b=a.kind;if('string'!=typeof b&&!0!==b&&!1!==b&&null!==b)throw new TypeError(`"kind" must be a string`);if(a.init&&'function'!=typeof a.init)throw new TypeError('"init" must be a function');if('function'!=typeof a.revive)throw new TypeError('"revive" must be a function');if(a.preserve&&'function'!=typeof a.preserve)throw new TypeError('"preserve" must be a function if provided')}return this._setReviver(a)}registerClass(a,b){return this.registerReviver({kind:a,revive(a,c){a=Object.assign(a,c.body),Object.setPrototypeOf(a,b.prototype)}}).match(b,b.prototype)}registerProto(a,b){return this.registerReviver({kind:a,revive(a,c){a=Object.assign(a,c.body),Object.setPrototypeOf(a,b)}}).match(b)}decode(a,b){if(null===a)return null;const c=decodeObjectTree(this,a,b);return c.done}encode(a,b){const c=[],d=encodeObjectTree(this,a,b,(a,b)=>{c[b.oid]=b.content}),e=JSON.stringify(`${this.token}refs`);return d.then(()=>`{${e}: [\n  ${c.join(',\n  ')} ]}\n`)}_boundFindPreserveForObj(){const a=this.lookupPreserver;return function(b){let c=a(b);if(void 0!==c)return c;if(c=a(b.constructor),void 0!==c)return c;for(let c,d=b;null!==(d=Object.getPrototypeOf(d));)if(c=a(d),void 0!==c)return c}}}class ReviverNotFound extends Error{}const createRegistry=Revitalization.create.bind(Revitalization);module.exports=exports=createRegistry(),Object.assign(exports,{Revitalization,ReviverNotFound,createRegistry,create:createRegistry});

//# sourceMappingURL=index.min.js.map